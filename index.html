<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Janus</title>
    <style>
        body { font-family: sans-serif; display: flex; padding: 20px; background-color: #f9f9f9; margin: 0; }
        #sidebar { width: 300px; border: 1px solid #ccc; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        #project-tree { list-style: none; padding: 0; }
        #project-tree ul { list-style: none; padding-left: 20px; }
        .project-item { 
            padding: 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; 
        }
        .project-item:hover { background-color: #f0f0f0; }
        .project-item.active { background-color: #e0e0ff; font-weight: bold; }
        .project-name-wrapper { display: flex; align-items: center; }
        .toggle { margin-right: 8px; width: 16px; text-align: center; font-size: 10px; user-select: none; }
        
        .sidebar-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .sidebar-actions button {
            flex-grow: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .project-actions {
            display: none; /* Hidden by default */
            gap: 5px;
        }
        .project-item:hover .project-actions {
            display: flex; /* Show on hover */
        }
        .project-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 4px;
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 20px 30px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 400px;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content input, .modal-content textarea {
            width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 15px;
            box-sizing: border-box;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions button {
            padding: 8px 15px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer;
        }
        .modal-actions button[type="submit"] {
            background-color: #4a90e2; border-color: #4a90e2; color: white;
        }
        .modal-actions .confirm-danger {
             background-color: #d9534f; border-color: #d9534f; color: white;
        }
        .hidden { display: none; }

        /* Tab Styles */
        .tab-container {
            display: flex;
            border-bottom: 2px solid #ccc;
            margin-top: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab-button:hover {
            background-color: #f0f0f0;
        }
        .tab-button.active {
            border-color: #007bff;
            font-weight: bold;
        }
        .tab-panel {
            display: none;
            padding-top: 20px;
        }
        .tab-panel.active {
            display: block;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #document-list a {
            text-decoration: none;
            color: #007bff;
        }
        #document-list a:hover {
            text-decoration: underline;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .remove-btn {
            background: none; border: none; color: red; cursor: pointer; font-size: 16px;
        }
        .comm-log-item small {
            color: #666;
            margin-left: 15px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Projects</h2>
        <div class="sidebar-actions">
            <button id="new-project-btn">New Project</button>
        </div>
        <p><small>Select a project to create a sub-project under it.</small></p>
        <ul id="project-tree"></ul>
    </div>
    
    <div id="main-content" style="padding-left: 20px; flex-grow: 1;">
        <h3>Selected Project:</h3>
        <p id="current-project-name">None</p>
    
        <div class="tab-container">
            <button class="tab-button active" data-tab="tasks-panel">Tasks</button>
            <button class="tab-button" data-tab="documents-panel">Documents</button>
            <button class="tab-button" data-tab="communication-panel">Communication</button>
            <button class="tab-button" data-tab="team-panel">Team</button>
        </div>
    
        <div class="tab-content-container">
            <div class="tab-panel active" id="tasks-panel">
                <h4>Task management board goes here.</h4>
            </div>
    
            <div class="tab-panel" id="documents-panel">
                <div class="panel-header">
                    <h4>Project Documents</h4>
                    <button id="add-document-btn">Add Document</button>
                </div>
                <ul id="document-list"></ul>
            </div>
    
            <div class="tab-panel" id="communication-panel">
                <div class="panel-header">
                    <h4>Communication Log</h4>
                    <button id="add-comm-btn">Add Log Entry</button>
                </div>
                <ul id="comm-list"></ul>
            </div>
    
            <div class="tab-panel" id="team-panel">
                <div class="panel-header">
                    <h4>Team Members</h4>
                    <button id="add-member-btn">Add Member</button>
                </div>
                <ul id="team-list"></ul>
            </div>
        </div>
    </div>

    <!-- Generic Reusable Modal -->
    <div id="generic-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title">Title</h3>
            <p id="modal-message" class="hidden"></p>
            <form id="modal-form">
                <div id="modal-input-container">
                    <div id="modal-input-group-1" class="hidden">
                        <label id="modal-input-label-1" for="modal-input-1">Label 1</label>
                        <input type="text" id="modal-input-1" autocomplete="off">
                    </div>
                    <div id="modal-input-group-2" class="hidden">
                        <label id="modal-input-label-2" for="modal-input-2">Label 2</label>
                        <input type="text" id="modal-input-2" autocomplete="off">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel-btn">Cancel</button>
                    <button type="submit" id="modal-confirm-btn">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- DATA STORE ---
        const projectService = {
            getAll: async () => JSON.parse(localStorage.getItem('janus_projects')) || [],
            saveAll: async (projects) => localStorage.setItem('janus_projects', JSON.stringify(projects)),
            add: async (data) => {
                const projects = await projectService.getAll();
                const newProject = { 
                    id: `proj_${crypto.randomUUID()}`, 
                    documents: [], team: [], comms: [],
                    ...data 
                };
                projects.push(newProject);
                await projectService.saveAll(projects);
                return newProject;
            },
            deleteProject: async (projectId) => {
                let projects = await projectService.getAll();
                const projectsToDelete = new Set([projectId]);
                let changed = true;
                while (changed) {
                    changed = false;
                    const children = projects.filter(p => projectsToDelete.has(p.parentId));
                    children.forEach(child => {
                        if (!projectsToDelete.has(child.id)) {
                            projectsToDelete.add(child.id);
                            changed = true;
                        }
                    });
                }
                const remainingProjects = projects.filter(p => !projectsToDelete.has(p.id));
                await projectService.saveAll(remainingProjects);
            },
            renameProject: async (projectId, newName) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    project.name = newName;
                    await projectService.saveAll(projects);
                }
            },
            addDocument: async (projectId, docData) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return null;
                const newDocument = { id: `doc_${crypto.randomUUID()}`, ...docData };
                project.documents.push(newDocument);
                await projectService.saveAll(projects);
                return newDocument;
            },
            addTeamMember: async (projectId, memberName) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return null;
                const newMember = { id: `mem_${crypto.randomUUID()}`, name: memberName };
                project.team.push(newMember);
                await projectService.saveAll(projects);
                return newMember;
            },
            removeTeamMember: async (projectId, memberId) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return;
                project.team = project.team.filter(m => m.id !== memberId);
                await projectService.saveAll(projects);
            },
            addCommLog: async (projectId, message) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return null;
                const newLog = { 
                    id: `comm_${crypto.randomUUID()}`, 
                    message,
                    timestamp: new Date().toISOString()
                };
                project.comms.unshift(newLog);
                await projectService.saveAll(projects);
                return newLog;
            }
        };

        // --- GLOBAL STATE ---
        let allProjects = [];
        let currentProjectId = null;
        let expandedProjects = new Set();
        const tabContainer = document.querySelector('.tab-container');
        const teamListEl = document.getElementById('team-list');
        
        // Modal Elements
        const modal = document.getElementById('generic-modal');
        const modalForm = document.getElementById('modal-form');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalInputGroup1 = document.getElementById('modal-input-group-1');
        const modalInput1 = document.getElementById('modal-input-1');
        const modalInputLabel1 = document.getElementById('modal-input-label-1');
        const modalInputGroup2 = document.getElementById('modal-input-group-2');
        const modalInput2 = document.getElementById('modal-input-2');
        const modalInputLabel2 = document.getElementById('modal-input-label-2');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        let modalResolve = null;

        // --- MODAL FUNCTIONS ---
        function showModal(options) {
            modalTitle.textContent = options.title;
            
            modalMessage.textContent = options.message || '';
            modalMessage.classList.toggle('hidden', !options.message);

            const hasInputs = options.inputs && options.inputs.length > 0;
            modalInputContainer.classList.toggle('hidden', !hasInputs);

            if (hasInputs) {
                const [input1, input2] = options.inputs;
                modalInputGroup1.classList.toggle('hidden', !input1);
                if (input1) {
                    modalInputLabel1.textContent = input1.label || '';
                    modalInput1.value = input1.value || '';
                }
                modalInputGroup2.classList.toggle('hidden', !input2);
                if (input2) {
                    modalInputLabel2.textContent = input2.label || '';
                    modalInput2.value = input2.value || '';
                }
            }

            modalConfirmBtn.textContent = options.confirmText || 'Confirm';
            modalConfirmBtn.className = options.danger ? 'confirm-danger' : '';

            modal.classList.remove('hidden');
            if (hasInputs) modalInput1.focus();

            return new Promise(resolve => {
                modalResolve = resolve;
            });
        }

        function hideModal() {
            modal.classList.add('hidden');
            modalForm.reset();
            modalResolve = null;
        }

        modalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (modalResolve) {
                const inputs = [modalInput1.value.trim(), modalInput2.value.trim()];
                modalResolve({ confirmed: true, inputs });
                hideModal();
            }
        });

        modalCancelBtn.addEventListener('click', () => {
             if (modalResolve) {
                modalResolve({ confirmed: false });
                hideModal();
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal && modalResolve) {
                modalResolve({ confirmed: false });
                hideModal();
            }
        });

        // --- CORE RENDER FUNCTIONS ---
        async function renderProjectTree() {
            allProjects = await projectService.getAll();
            const treeEl = document.getElementById('project-tree');
            treeEl.innerHTML = '';
            const projectMap = new Map(allProjects.map(p => [p.id, { ...p, children: [] }]));
            const rootProjects = [];
            projectMap.forEach(project => {
                if (project.parentId && projectMap.has(project.parentId)) {
                    projectMap.get(project.parentId).children.push(project);
                } else {
                    rootProjects.push(project);
                }
            });
            rootProjects.sort((a,b) => a.name.localeCompare(b.name)).forEach(project => {
                treeEl.appendChild(createProjectNode(project));
            });
        }

        function createProjectNode(project) {
            const li = document.createElement('li');
            li.dataset.id = project.id;
            const hasChildren = project.children && project.children.length > 0;
            const projectItemDiv = document.createElement('div');
            projectItemDiv.className = 'project-item';
            
            if (project.id === currentProjectId) projectItemDiv.classList.add('active');
            projectItemDiv.innerHTML = `
                <div class="project-name-wrapper" data-action="select">
                    <span class="toggle">${hasChildren ? '‚ñ∂' : '‚Ä¢'}</span>
                    <span>${project.name}</span>
                </div>
                <div class="project-actions">
                    <button class="project-action-btn" data-action="rename" title="Rename Project">‚úèÔ∏è</button>
                    <button class="project-action-btn" data-action="delete" title="Delete Project">üóëÔ∏è</button>
                </div>
            `;
            li.appendChild(projectItemDiv);
            if (hasChildren) {
                const ul = document.createElement('ul');
                ul.style.display = expandedProjects.has(project.id) ? 'block' : 'none';
                projectItemDiv.querySelector('.toggle').textContent = expandedProjects.has(project.id) ? '‚ñº' : '‚ñ∂';
                project.children.sort((a,b) => a.name.localeCompare(b.name)).forEach(child => {
                    ul.appendChild(createProjectNode(child));
                });
                li.appendChild(ul);
            }
            return li;
        }
        
        function addProjectNodeToDOM(project) {
            const newNode = createProjectNode({ ...project, children: [] });
            let parentElement;
            if (project.parentId) {
                const parentLi = document.querySelector(`li[data-id="${project.parentId}"]`);
                parentElement = parentLi.querySelector('ul');
                if (!parentElement) {
                    parentElement = document.createElement('ul');
                    parentLi.appendChild(parentElement);
                    parentLi.querySelector('.toggle').textContent = '‚ñ∂'; 
                }
                parentElement.style.display = 'block';
                parentLi.querySelector('.toggle').textContent = '‚ñº';
            } else {
                parentElement = document.getElementById('project-tree');
            }
            parentElement.appendChild(newNode);
            const children = Array.from(parentElement.children);
            children.sort((a, b) => a.textContent.trim().localeCompare(b.textContent.trim()));
            children.forEach(child => parentElement.appendChild(child));
        }

        function selectProject(projectId) {
            currentProjectId = projectId;
            const project = allProjects.find(p => p.id === projectId);
            document.getElementById('current-project-name').textContent = project ? project.name : 'None';
            
            renderDocuments(projectId);
            renderTeam(projectId);
            renderComms(projectId);
            
            // Re-render tree to update active state
            renderProjectTree();
        }

        function renderDocuments(projectId) {
            const documentListEl = document.getElementById('document-list');
            documentListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.documents || project.documents.length === 0) {
                documentListEl.innerHTML = '<li class="list-item">No documents yet.</li>';
                return;
            }
            project.documents.forEach(doc => {
                const li = document.createElement('li');
                li.className = 'list-item';
                const a = document.createElement('a');
                a.href = doc.url;
                a.textContent = doc.name;
                a.target = '_blank';
                li.appendChild(a);
                documentListEl.appendChild(li);
            });
        }

        function renderTeam(projectId) {
            teamListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.team || project.team.length === 0) {
                teamListEl.innerHTML = '<li class="list-item">No team members assigned.</li>';
                return;
            }
            project.team.forEach(member => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.innerHTML = `
                    <span>${member.name}</span>
                    <button class="remove-btn" data-member-id="${member.id}">&times;</button>
                `;
                teamListEl.appendChild(li);
            });
        }

        function renderComms(projectId) {
            const commListEl = document.getElementById('comm-list');
            commListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.comms || project.comms.length === 0) {
                commListEl.innerHTML = '<li class="list-item">No communication logs.</li>';
                return;
            }
            project.comms.forEach(log => {
                const li = document.createElement('li');
                li.className = 'list-item comm-log-item';
                const date = new Date(log.timestamp).toLocaleString();
                li.innerHTML = `
                    <span>${log.message}</span>
                    <small>${date}</small>
                `;
                commListEl.appendChild(li);
            });
        }

        // --- EVENT LISTENERS ---
        document.getElementById('sidebar').addEventListener('click', (e) => {
            const newProjectBtn = e.target.closest('#new-project-btn');
            const actionTarget = e.target.closest('[data-action]');
            
            if (newProjectBtn) {
                showModal({
                    title: 'Create New Project',
                    inputs: [{ label: 'Project Name' }],
                    confirmText: 'Create'
                }).then(async ({ confirmed, inputs }) => {
                    if (confirmed && inputs[0]) {
                        const newProject = await projectService.add({ name: inputs[0], parentId: currentProjectId || null });
                        allProjects.push(newProject);
                        if (currentProjectId) expandedProjects.add(currentProjectId);
                        addProjectNodeToDOM(newProject);
                        selectProject(newProject.id);
                    }
                });
                return;
            }

            if (actionTarget) {
                const action = actionTarget.dataset.action;
                const projectItem = actionTarget.closest('.project-item');
                const projectId = projectItem.parentElement.dataset.id;
                const project = allProjects.find(p => p.id === projectId);

                switch (action) {
                    case 'select':
                        selectProject(projectId);
                        const sublist = projectItem.parentElement.querySelector('ul');
                        if (sublist) {
                            const isHidden = sublist.style.display === 'none';
                            sublist.style.display = isHidden ? 'block' : 'none';
                            projectItem.querySelector('.toggle').textContent = isHidden ? '‚ñº' : '‚ñ∂';
                            if (isHidden) expandedProjects.add(projectId);
                            else expandedProjects.delete(projectId);
                        }
                        break;
                    
                    case 'rename':
                        showModal({
                            title: `Rename "${project.name}"`,
                            inputs: [{ label: 'New Project Name', value: project.name }],
                            confirmText: 'Rename'
                        }).then(async ({ confirmed, inputs }) => {
                            if (confirmed && inputs[0]) {
                                await projectService.renameProject(projectId, inputs[0]);
                                renderProjectTree();
                            }
                        });
                        break;

                    case 'delete':
                        showModal({
                            title: 'Delete Project',
                            message: `Are you sure you want to delete "${project.name}" and all its sub-projects? This action cannot be undone.`,
                            confirmText: 'Delete',
                            danger: true
                        }).then(async ({ confirmed }) => {
                            if (confirmed) {
                                await projectService.deleteProject(projectId);
                                if (currentProjectId === projectId) currentProjectId = null;
                                initializeApp();
                            }
                        });
                        break;
                }
            }
        });
        
        tabContainer.addEventListener('click', (e) => {
            const clickedTab = e.target.closest('.tab-button');
            if (!clickedTab) return;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            clickedTab.classList.add('active');
            const tabId = clickedTab.dataset.tab;
            document.getElementById(tabId).classList.add('active');
        });

        document.getElementById('add-document-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            showModal({
                title: 'Add New Document',
                inputs: [
                    { label: 'Document Name (e.g., "Project Brief")' },
                    { label: 'Document URL (e.g., "https://docs.google.com/...")' }
                ],
                confirmText: 'Add'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0] && inputs[1]) {
                    await projectService.addDocument(currentProjectId, { name: inputs[0], url: inputs[1] });
                    allProjects = await projectService.getAll();
                    renderDocuments(currentProjectId);
                }
            });
        });

        document.getElementById('add-member-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            showModal({
                title: 'Add Team Member',
                inputs: [{ label: 'Member Name' }],
                confirmText: 'Add'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    await projectService.addTeamMember(currentProjectId, inputs[0]);
                    allProjects = await projectService.getAll();
                    renderTeam(currentProjectId);
                }
            });
        });

        teamListEl.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-btn');
            if (removeBtn) {
                const memberId = removeBtn.dataset.memberId;
                showModal({
                    title: 'Remove Team Member',
                    message: 'Are you sure you want to remove this team member?',
                    confirmText: 'Remove',
                    danger: true
                }).then(async ({ confirmed }) => {
                    if (confirmed) {
                        await projectService.removeTeamMember(currentProjectId, memberId);
                        allProjects = await projectService.getAll();
                        renderTeam(currentProjectId);
                    }
                });
            }
        });
        
        document.getElementById('add-comm-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            showModal({
                title: 'Add Communication Log',
                inputs: [{ label: 'Log Message' }],
                confirmText: 'Add Log'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    await projectService.addCommLog(currentProjectId, inputs[0]);
                    allProjects = await projectService.getAll();
                    renderComms(currentProjectId);
                }
            });
        });

        // --- INITIALIZATION ---
        async function initializeApp() {
            const existingProjects = await projectService.getAll();
            if (existingProjects.length === 0) {
                 await projectService.add({ name: 'Main Project Alpha' });
            }
            await renderProjectTree();
            
            if (!currentProjectId && allProjects.length > 0) {
                 const firstProjectId = allProjects.find(p => !p.parentId)?.id || allProjects[0].id;
                 selectProject(firstProjectId);
            } else if (allProjects.length === 0) {
                selectProject(null);
            } else {
                // Reselect the current project to refresh the view
                selectProject(currentProjectId);
            }
        }

        initializeApp();
    </script>
</body>
</html>
