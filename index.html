<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Janus</title>
    <style>
        body { font-family: sans-serif; display: flex; padding: 20px; background-color: #f9f9f9; margin: 0; }
        .hidden { display: none !important; }

        /* Auth Screen Styles */
        #auth-container {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
        }
        #auth-box {
            width: 350px;
            padding: 30px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        #auth-box h2 { text-align: center; margin-top: 0; }
        #auth-box input {
            width: 100%; padding: 10px; margin-bottom: 15px; box-sizing: border-box;
        }
        #auth-box button {
            width: 100%; padding: 10px; border: none; border-radius: 5px;
            background-color: #4a90e2; color: white; font-size: 16px; cursor: pointer;
        }
        #auth-toggle {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #007bff;
            cursor: pointer;
        }
        #auth-error {
            color: red;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        }

        /* Main App Styles */
        #app-container {
            display: flex;
            width: 100%;
        }
        #sidebar { width: 300px; border: 1px solid #ccc; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        #main-nav { list-style: none; padding: 0; margin: 0; }
        .main-nav-item { padding: 12px 8px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 500; }
        .main-nav-item:hover { background-color: #f0f0f0; }
        .main-nav-item.active { background-color: #e0e0ff; font-weight: bold; }
        #project-tree-container { padding-left: 20px; }
        #project-tree { list-style: none; padding: 0; margin-top: 10px; }
        #project-tree ul { list-style: none; padding-left: 20px; }
        .project-item { padding: 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .project-item:hover { background-color: #f0f0f0; }
        .project-item.active { background-color: #d0d0ff; }
        .project-name-wrapper { display: flex; align-items: center; flex-grow: 1; min-width: 0; }
        .project-name-wrapper span:last-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toggle { margin-right: 8px; width: 16px; text-align: center; font-size: 10px; user-select: none; }
        .project-icon { margin-right: 8px; }
        .sidebar-actions { display: flex; gap: 10px; margin-bottom: 10px; }
        .sidebar-actions button { padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        .project-actions { display: none; gap: 5px; }
        .project-item:hover .project-actions { display: flex; }
        .project-action-btn { background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px 4px; }
        #logout-btn { width: 100%; margin-top: 20px; background-color: #f0f0f0; }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 20px 30px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 450px;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 15px;
            box-sizing: border-box;
        }
        .modal-content textarea { min-height: 80px; resize: vertical; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions button { padding: 8px 15px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        .modal-actions button[type="submit"] { background-color: #4a90e2; border-color: #4a90e2; color: white; }
        .modal-actions .confirm-danger { background-color: #d9534f; border-color: #d9534f; color: white; }
        
        /* Tab Styles */
        .tab-container { display: flex; border-bottom: 2px solid #ccc; margin-top: 20px; }
        .tab-button { padding: 10px 20px; border: none; background-color: transparent; cursor: pointer; font-size: 16px; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-button:hover { background-color: #f0f0f0; }
        .tab-button.active { border-color: #007bff; font-weight: bold; }
        .main-panel, .tab-panel { display: none; }
        .main-panel.active, .tab-panel.active { display: block; }
        .tab-panel { padding-top: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .remove-btn { background: none; border: none; color: red; cursor: pointer; font-size: 16px; }
        .comm-log-item small { color: #666; margin-left: 15px; flex-shrink: 0; }

        /* Kanban Styles */
        .kanban-board { display: flex; gap: 20px; width: 100%; overflow-x: auto; }
        .kanban-column { flex: 1; min-width: 250px; background-color: #f4f5f7; border-radius: 8px; padding: 10px; }
        .kanban-column h4 { margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #ccc; }
        .kanban-tasks { min-height: 200px; display: flex; flex-direction: column; gap: 10px; }
        .task-card { background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: grab; border-left: 5px solid transparent; }
        .task-card.priority-high { border-left-color: #d9534f; }
        .task-card.priority-medium { border-left-color: #f0ad4e; }
        .task-card.priority-low { border-left-color: #5cb85c; }
        .task-card .task-name { font-weight: bold; margin-bottom: 10px; }
        .task-card .task-details { font-size: 12px; color: #555; }
        .task-card.dragging { opacity: 0.5; }
        .drag-over { background-color: #e0e0ff; }
        
        /* Calendar Styles */
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #calendar-view-controls button { margin: 0 5px; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { border: 1px solid #ccc; min-height: 120px; padding: 5px; background-color: #fff; cursor: pointer; }
        .calendar-day:hover { background-color: #f9f9f9; }
        .calendar-day-header { font-weight: bold; text-align: center; padding-bottom: 5px; }
        .calendar-day-number { font-size: 12px; color: #555; }
        .calendar-task { font-size: 11px; padding: 2px 4px; border-radius: 3px; background-color: #e0e0ff; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .calendar-event { background-color: #5cb85c; color: white; }
        #year-view { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .month-grid { border: 1px solid #ccc; padding: 5px; }
        .month-grid h5 { text-align: center; margin: 5px 0; }
        .month-grid .calendar-day { min-height: 20px; font-size: 10px; }
        
        /* Contacts, Invoices, Expenses Styles */
        #contact-list, #invoice-list, #expense-list { list-style: none; padding: 0; }
        .contact-item, .invoice-item, .expense-item { background-color: #fff; padding: 15px; border-radius: 5px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .contact-info div, .invoice-info div, .expense-info div { margin-bottom: 5px; }
        .contact-name, .invoice-client, .expense-description { font-weight: bold; }
        .contact-company, .invoice-details, .expense-details { color: #555; font-style: italic; }
        .contact-channels { font-size: 12px; color: #777; }
        .contact-channels span { margin-right: 5px; }
        .item-actions { display: flex; gap: 10px; align-items: center; }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; color: white; }
        .status-draft { background-color: #777; }
        .status-sent { background-color: #f0ad4e; }
        .status-paid { background-color: #5cb85c; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div id="auth-box">
            <h2 id="auth-title">Login</h2>
            <p id="auth-error"></p>
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="Email" required>
                <input type="password" id="auth-password" placeholder="Password" required>
                <button type="submit" id="auth-submit-btn">Login</button>
            </form>
            <p id="auth-toggle">Don't have an account? Sign Up</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="sidebar">
            <h2>Janus</h2>
            <ul id="main-nav">
                <li class="main-nav-item active" data-panel="project-panel">üìÅ Projects</li>
                <div id="project-tree-container">
                     <div class="sidebar-actions">
                        <button id="new-project-btn">New Project</button>
                    </div>
                    <p><small>Select a project to create a sub-project under it.</small></p>
                    <ul id="project-tree"></ul>
                </div>
                <li class="main-nav-item" data-panel="calendar-panel">üìÖ Calendar</li>
                <li class="main-nav-item" data-panel="contacts-panel">üë• Contacts</li>
                <li class="main-nav-item" data-panel="invoices-panel">üßæ Invoices</li>
                <li class="main-nav-item" data-panel="expenses-panel">üí∂ Expenses</li>
            </ul>
            <button id="logout-btn">Logout</button>
        </div>
        
        <div id="main-content" style="padding-left: 20px; flex-grow: 1;">
            <div class="main-panel active" id="project-panel">
                <h3>Selected Project:</h3>
                <p id="current-project-name">None</p>
            
                <div class="tab-container" id="project-tabs">
                    <button class="tab-button active" data-tab="tasks-panel">Tasks</button>
                    <button class="tab-button" data-tab="documents-panel">Documents</button>
                    <button class="tab-button" data-tab="communication-panel">Communication</button>
                    <button class="tab-button" data-tab="team-panel">Team</button>
                </div>
            
                <div class="tab-content-container">
                    <div class="tab-panel active" id="tasks-panel">
                         <div class="panel-header">
                            <h4>Task Board</h4>
                            <button id="add-task-btn">New Task</button>
                        </div>
                        <div class="kanban-board">
                            <div class="kanban-column" data-status="mytodo">
                                <h4>My To Do</h4>
                                <div class="kanban-tasks"></div>
                            </div>
                             <div class="kanban-column" data-status="assignedtodo">
                                <h4>Assigned To Do</h4>
                                <div class="kanban-tasks"></div>
                            </div>
                            <div class="kanban-column" data-status="inprogress">
                                <h4>In Progress</h4>
                                <div class="kanban-tasks"></div>
                            </div>
                            <div class="kanban-column" data-status="done">
                                <h4>Done</h4>
                                <div class="kanban-tasks"></div>
                            </div>
                        </div>
                    </div>
            
                    <div class="tab-panel" id="documents-panel">
                        <div class="panel-header">
                            <h4>Project Documents</h4>
                            <button id="add-document-btn">Add Document</button>
                        </div>
                        <ul id="document-list"></ul>
                    </div>
            
                    <div class="tab-panel" id="communication-panel">
                        <div class="panel-header">
                            <h4>Communication Log</h4>
                            <button id="add-comm-btn">Add Log Entry</button>
                        </div>
                        <ul id="comm-list"></ul>
                    </div>
            
                    <div class="tab-panel" id="team-panel">
                        <div class="panel-header">
                            <h4>Team Members</h4>
                            <button id="add-member-btn">Add Member</button>
                        </div>
                        <ul id="team-list"></ul>
                    </div>
                </div>
            </div>
            <div class="main-panel" id="calendar-panel">
                <div id="calendar-header">
                    <button id="prev-btn">&lt;</button>
                    <h3 id="month-year-display">Month Year</h3>
                    <button id="next-btn">&gt;</button>
                    <div id="calendar-view-controls">
                        <button data-view="week">Week</button>
                        <button data-view="month">Month</button>
                        <button data-view="year">Year</button>
                    </div>
                    <button id="add-appointment-btn">New Appointment</button>
                </div>
                <div id="calendar-grid"></div>
                <div id="year-view" class="hidden"></div>
            </div>
            <div class="main-panel" id="contacts-panel">
                <div class="panel-header">
                    <h2>Contacts (CRM)</h2>
                    <button id="add-contact-btn">Add Contact</button>
                </div>
                <ul id="contact-list"></ul>
            </div>
            <div class="main-panel" id="invoices-panel">
                <div class="panel-header">
                    <h2>Invoices</h2>
                    <button id="create-invoice-btn">Create Invoice</button>
                </div>
                <ul id="invoice-list"></ul>
            </div>
            <div class="main-panel" id="expenses-panel">
                <div class="panel-header">
                    <h2>Expenses</h2>
                    <div>
                        <button id="export-expenses-btn">Export Reports</button>
                        <button id="add-expense-btn">Add Expense</button>
                    </div>
                </div>
                <ul id="expense-list"></ul>
            </div>
        </div>
    </div>

    <!-- Generic Reusable Modal -->
    <div id="generic-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title">Title</h3>
            <p id="modal-message" class="hidden"></p>
            <form id="modal-form">
                <div id="modal-input-container">
                    <!-- JS will generate inputs here -->
                </div>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel-btn">Cancel</button>
                    <button type="submit" id="modal-confirm-btn">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, writeBatch, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhb65qgc3OPYkqOvFDcdUY0RwO2GRjBlI",
            authDomain: "project-janus-app.firebaseapp.com",
            projectId: "project-janus-app",
            storageBucket: "project-janus-app.firebasestorage.app",
            messagingSenderId: "830301768579",
            appId: "1:830301768579:web:e050e4746a107059f584b6",
            measurementId: "G-LK79N7HB65"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let allProjects = [];
        let allContacts = [];
        let allInvoices = [];
        let allExpenses = [];
        let allEvents = [];
        let currentProjectId = null;
        let expandedProjects = new Set();
        let currentUserId = null;
        let unsubscribeListeners = [];
        
        const teamListEl = document.getElementById('team-list');
        let currentCalendarDate = new Date();
        let currentCalendarView = 'month';
        
        // UI Elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggle = document.getElementById('auth-toggle');
        const authError = document.getElementById('auth-error');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const logoutBtn = document.getElementById('logout-btn');

        // Modal Elements
        const modal = document.getElementById('generic-modal');
        const modalForm = document.getElementById('modal-form');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        let modalResolve = null;

        // --- DATA SERVICES (FIREBASE) ---
        const getCollectionRef = (coll) => collection(db, 'users', currentUserId, coll);

        const projectService = {
            add: (data) => addDoc(getCollectionRef('projects'), { ...data, icon: getIconForProjectName(data.name) }),
            renameProject: (id, newName) => updateDoc(doc(db, 'users', currentUserId, 'projects', id), { name: newName, icon: getIconForProjectName(newName) }),
            deleteProject: async (id) => {
                const batch = writeBatch(db);
                const projectsToDelete = new Set([id]);
                let changed = true;
                while(changed) {
                    changed = false;
                    const q = query(getCollectionRef('projects'), where('parentId', 'in', Array.from(projectsToDelete)));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(doc => {
                        if (!projectsToDelete.has(doc.id)) {
                            projectsToDelete.add(doc.id);
                            changed = true;
                        }
                    });
                }
                projectsToDelete.forEach(projectId => batch.delete(doc(db, 'users', currentUserId, 'projects', projectId)));
                await batch.commit();
            },
            addTeamMember: (id, contactId) => {
                const project = allProjects.find(p => p.id === id);
                const updatedTeam = [...(project.team || []), contactId];
                return updateDoc(doc(db, 'users', currentUserId, 'projects', id), { team: updatedTeam });
            },
            removeTeamMember: (id, contactId) => {
                 const project = allProjects.find(p => p.id === id);
                 const updatedTeam = (project.team || []).filter(cid => cid !== contactId);
                 return updateDoc(doc(db, 'users', currentUserId, 'projects', id), { team: updatedTeam });
            },
            updateProjectSubcollection: (projectId, subcollection, data) => {
                 const project = allProjects.find(p => p.id === projectId);
                 const updatedCollection = [...(project[subcollection] || []), data];
                 return updateDoc(doc(db, 'users', currentUserId, 'projects', projectId), { [subcollection]: updatedCollection });
            },
            updateTask: (projectId, taskId, updatedData) => {
                const project = allProjects.find(p => p.id === projectId);
                const updatedTasks = project.tasks.map(t => t.id === taskId ? {...t, ...updatedData} : t);
                return updateDoc(doc(db, 'users', currentUserId, 'projects', projectId), { tasks: updatedTasks });
            },
            updateTaskStatus: (projectId, taskId, newStatus) => {
                const project = allProjects.find(p => p.id === projectId);
                const task = project.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = newStatus;
                    return updateDoc(doc(db, 'users', currentUserId, 'projects', projectId), { tasks: project.tasks });
                }
            }
        };

        const contactService = {
            add: (data) => addDoc(getCollectionRef('contacts'), data),
            update: (id, data) => updateDoc(doc(db, 'users', currentUserId, 'contacts', id), data),
            delete: (id) => deleteDoc(doc(db, 'users', currentUserId, 'contacts', id)),
        };

        const invoiceService = {
            add: (data) => addDoc(getCollectionRef('invoices'), data),
            update: (id, data) => updateDoc(doc(db, 'users', currentUserId, 'invoices', id), data),
            delete: (id) => deleteDoc(doc(db, 'users', currentUserId, 'invoices', id)),
        };

        const expenseService = {
            add: (data) => addDoc(getCollectionRef('expenses'), data),
            update: (id, data) => updateDoc(doc(db, 'users', currentUserId, 'expenses', id), data),
            delete: (id) => deleteDoc(doc(db, 'users', currentUserId, 'expenses', id)),
        };
        
        const eventService = {
            add: (data) => addDoc(getCollectionRef('events'), data),
            update: (id, data) => updateDoc(doc(db, 'users', currentUserId, 'events', id), data),
            delete: (id) => deleteDoc(doc(db, 'users', currentUserId, 'events', id)),
        };


        // --- HELPER FUNCTIONS ---
        function formatDateGerman(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function getIconForProjectName(name) {
            const lowerName = name.toLowerCase();
            const iconMap = {
                'germany': 'üá©üá™', 'deutschland': 'üá©üá™', 'usa': 'üá∫üá∏', 'america': 'üá∫üá∏',
                'france': 'üá´üá∑', 'spain': 'üá™üá∏', 'italy': 'üáÆüáπ', 'uk': 'üá¨üáß', 'england': 'üá¨üáß',
                'canada': 'üá®üá¶', 'australia': 'üá¶üá∫', 'japan': 'üáØüáµ', 'china': 'üá®üá≥',
                'india': 'üáÆüá≥', 'brazil': 'üáßüá∑', 'africa': 'üåç', 'europe': 'üá™üá∫', 'asia': 'üåè',
                'marketing': 'üìà', 'finance': 'üí∞', 'development': 'üíª', 'dev': 'üíª', 'code': 'üíª',
                'design': 'üé®', 'sales': 'ü§ù', 'hr': 'üë•', 'human resources': 'üë•',
                'personal': 'üë§', 'home': 'üè†', 'work': 'üíº'
            };
            for (const key in iconMap) {
                if (lowerName.includes(key)) return iconMap[key];
            }
            return 'üìÅ';
        }

        // --- MODAL FUNCTIONS ---
        function showModal(options) {
            modalTitle.textContent = options.title;
            
            modalMessage.textContent = options.message || '';
            modalMessage.classList.toggle('hidden', !options.message);

            modalInputContainer.innerHTML = '';
            if (options.inputs) {
                options.inputs.forEach((input, index) => {
                    const id = `modal-input-${index}`;
                    const group = document.createElement('div');
                    const label = document.createElement('label');
                    label.htmlFor = id;
                    label.textContent = input.label;
                    group.appendChild(label);

                    if (input.type === 'select') {
                        const select = document.createElement('select');
                        select.id = id;
                        input.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.text;
                            if (opt.value === input.value) option.selected = true;
                            select.appendChild(option);
                        });
                        group.appendChild(select);
                    } else if (input.type === 'textarea') {
                        const textarea = document.createElement('textarea');
                        textarea.id = id;
                        textarea.value = input.value || '';
                        group.appendChild(textarea);
                    } else {
                        const inputEl = document.createElement('input');
                        inputEl.type = input.type || 'text';
                        inputEl.id = id;
                        inputEl.value = input.value || '';
                        inputEl.autocomplete = 'off';
                        group.appendChild(inputEl);
                    }
                    modalInputContainer.appendChild(group);
                });
            }

            modalConfirmBtn.textContent = options.confirmText || 'Confirm';
            modalConfirmBtn.className = options.danger ? 'confirm-danger' : '';

            modal.classList.remove('hidden');
            if (options.inputs) modalInputContainer.querySelector('input, select, textarea')?.focus();

            return new Promise(resolve => {
                modalResolve = resolve;
            });
        }

        function hideModal() {
            modal.classList.add('hidden');
            modalForm.reset();
            modalResolve = null;
        }

        modalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (modalResolve) {
                const inputs = Array.from(modalInputContainer.querySelectorAll('input, select, textarea')).map(el => el.value.trim());
                modalResolve({ confirmed: true, inputs });
                hideModal();
            }
        });

        modalCancelBtn.addEventListener('click', () => {
             if (modalResolve) {
                modalResolve({ confirmed: false });
                hideModal();
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal && modalResolve) {
                modalResolve({ confirmed: false });
                hideModal();
            }
        });

        // --- CORE RENDER FUNCTIONS ---
        function renderProjectTree() {
            const treeEl = document.getElementById('project-tree');
            treeEl.innerHTML = '';
            const projectMap = new Map(allProjects.map(p => [p.id, { ...p, children: [] }]));
            const rootProjects = [];
            projectMap.forEach(project => {
                if (project.parentId && projectMap.has(project.parentId)) {
                    projectMap.get(project.parentId).children.push(project);
                } else {
                    rootProjects.push(project);
                }
            });
            rootProjects.sort((a,b) => a.name.localeCompare(b.name)).forEach(project => {
                treeEl.appendChild(createProjectNode(project));
            });
        }

        function createProjectNode(project) {
            const li = document.createElement('li');
            li.dataset.id = project.id;
            const hasChildren = project.children && project.children.length > 0;
            const projectItemDiv = document.createElement('div');
            projectItemDiv.className = 'project-item';
            
            if (project.id === currentProjectId) projectItemDiv.classList.add('active');
            projectItemDiv.innerHTML = `
                <div class="project-name-wrapper" data-action="select">
                    <span class="toggle">${hasChildren ? '‚ñ∂' : '‚Ä¢'}</span>
                    <span class="project-icon">${project.icon || 'üìÅ'}</span>
                    <span>${project.name}</span>
                </div>
                <div class="project-actions">
                    <button class="project-action-btn" data-action="rename" title="Rename Project">‚úèÔ∏è</button>
                    <button class="project-action-btn" data-action="delete" title="Delete Project">üóëÔ∏è</button>
                </div>
            `;
            li.appendChild(projectItemDiv);
            if (hasChildren) {
                const ul = document.createElement('ul');
                ul.style.display = expandedProjects.has(project.id) ? 'block' : 'none';
                projectItemDiv.querySelector('.toggle').textContent = expandedProjects.has(project.id) ? '‚ñº' : '‚ñ∂';
                project.children.sort((a,b) => a.name.localeCompare(b.name)).forEach(child => {
                    ul.appendChild(createProjectNode(child));
                });
                li.appendChild(ul);
            }
            return li;
        }
        
        function selectProject(projectId) {
            currentProjectId = projectId;
            const project = allProjects.find(p => p.id === projectId);
            document.getElementById('current-project-name').textContent = project ? project.name : 'None';
            
            renderDocuments(projectId);
            renderTeam(projectId);
            renderComms(projectId);
            renderTasks(projectId);
            
            renderProjectTree();
        }

        function renderDocuments(projectId) {
            const documentListEl = document.getElementById('document-list');
            documentListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.documents || project.documents.length === 0) {
                documentListEl.innerHTML = '<li class="list-item">No documents yet.</li>';
                return;
            }
            project.documents.forEach(doc => {
                const li = document.createElement('li');
                li.className = 'list-item';
                const a = document.createElement('a');
                a.href = doc.url;
                a.textContent = doc.name;
                a.target = '_blank';
                li.appendChild(a);
                documentListEl.appendChild(li);
            });
        }

        function renderTeam(projectId) {
            teamListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.team || project.team.length === 0) {
                teamListEl.innerHTML = '<li class="list-item">No team members assigned.</li>';
                return;
            }
            project.team.forEach(contactId => {
                const contact = allContacts.find(c => c.id === contactId);
                if (contact) {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <span>${contact.name}</span>
                        <button class="remove-btn" data-contact-id="${contact.id}">&times;</button>
                    `;
                    teamListEl.appendChild(li);
                }
            });
        }

        function renderComms(projectId) {
            const commListEl = document.getElementById('comm-list');
            commListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.comms || project.comms.length === 0) {
                commListEl.innerHTML = '<li class="list-item">No communication logs.</li>';
                return;
            }
            project.comms.forEach(log => {
                const li = document.createElement('li');
                li.className = 'list-item comm-log-item';
                const date = new Date(log.timestamp).toLocaleString();
                li.innerHTML = `
                    <span>${log.message}</span>
                    <small>${date}</small>
                `;
                commListEl.appendChild(li);
            });
        }

        function renderTasks(projectId) {
            document.querySelectorAll('.kanban-tasks').forEach(col => col.innerHTML = '');
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.tasks) return;

            project.tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                taskCard.classList.add(`priority-${task.priority || 'low'}`);
                taskCard.draggable = true;
                taskCard.dataset.taskId = task.id;
                taskCard.innerHTML = `
                    <div class="task-name">${task.name}</div>
                    <div class="task-details">
                        <div>üë§ ${task.assignee}</div>
                        <div>üóìÔ∏è ${formatDateGerman(task.startDate)} ‚Üí ${formatDateGerman(task.endDate)}</div>
                    </div>
                `;
                
                const column = document.querySelector(`.kanban-column[data-status="${task.status}"] .kanban-tasks`);
                if (column) {
                    column.appendChild(taskCard);
                }
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const yearView = document.getElementById('year-view');
            const display = document.getElementById('month-year-display');
            grid.innerHTML = '';
            yearView.innerHTML = '';

            grid.classList.toggle('hidden', currentCalendarView === 'year');
            yearView.classList.toggle('hidden', currentCalendarView !== 'year');

            const allTasks = allProjects.flatMap(p => (p.tasks || []).map(t => ({...t, projectName: p.name})));
            const allCalendarEvents = allEvents.map(e => ({...e, type: 'event'}));

            if (currentCalendarView === 'year') {
                display.textContent = currentCalendarDate.getFullYear();
                for (let i = 0; i < 12; i++) {
                    const monthGrid = document.createElement('div');
                    monthGrid.className = 'month-grid';
                    const monthName = new Date(currentCalendarDate.getFullYear(), i).toLocaleString('de-DE', { month: 'long' });
                    monthGrid.innerHTML = `<h5>${monthName}</h5>`;
                    yearView.appendChild(monthGrid);
                }
                return;
            }

            if (currentCalendarView === 'week') {
                const startOfWeek = new Date(currentCalendarDate);
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + (startOfWeek.getDay() === 0 ? -6 : 1));
                display.textContent = `Week of ${formatDateGerman(startOfWeek.toISOString())}`;
                grid.innerHTML = ''; 
                ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'calendar-day-header';
                    dayHeader.textContent = day;
                    grid.appendChild(dayHeader);
                });

                let dayIterator = new Date(startOfWeek);
                for(let i=0; i<7; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';
                    dayCell.dataset.date = dayIterator.toISOString().split('T')[0];
                    dayCell.innerHTML = `<div class="calendar-day-number">${dayIterator.getDate()}</div>`;
                    
                    allTasks.forEach(task => {
                        const startDate = new Date(task.startDate);
                        const endDate = new Date(task.endDate);
                        if (dayIterator >= startDate && dayIterator <= endDate) {
                            const taskEl = document.createElement('div');
                            taskEl.className = 'calendar-task';
                            taskEl.textContent = `${task.projectName}: ${task.name}`;
                            dayCell.appendChild(taskEl);
                        }
                    });
                    allCalendarEvents.forEach(event => {
                        const eventDate = new Date(event.date);
                        if(dayIterator.toDateString() === eventDate.toDateString()){
                             const eventEl = document.createElement('div');
                            eventEl.className = 'calendar-task calendar-event';
                            eventEl.textContent = `${event.startTime} ${event.title}`;
                            dayCell.appendChild(eventEl);
                        }
                    });

                    grid.appendChild(dayCell);
                    dayIterator.setDate(dayIterator.getDate() + 1);
                }
                return;
            }

            // Month view logic
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            display.textContent = new Date(year, month).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            for (let i = 0; i < (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1); i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                const date = new Date(year, month, day);
                dayCell.dataset.date = date.toISOString().split('T')[0];
                dayCell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                
                allTasks.forEach(task => {
                    const startDate = new Date(task.startDate);
                    const endDate = new Date(task.endDate);
                    if (date >= startDate && date <= endDate) {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'calendar-task';
                        taskEl.textContent = `${task.projectName}: ${task.name}`;
                        dayCell.appendChild(taskEl);
                    }
                });
                 allCalendarEvents.forEach(event => {
                    const eventDate = new Date(event.date);
                    if(date.toDateString() === eventDate.toDateString()){
                         const eventEl = document.createElement('div');
                        eventEl.className = 'calendar-task calendar-event';
                        eventEl.textContent = `${event.startTime} ${event.title}`;
                        dayCell.appendChild(eventEl);
                    }
                });
                grid.appendChild(dayCell);
            }
        }
        
        function renderContacts() {
            const contactListEl = document.getElementById('contact-list');
            contactListEl.innerHTML = '';
            if (allContacts.length === 0) {
                contactListEl.innerHTML = '<li class="list-item">No contacts yet.</li>';
                return;
            }
            allContacts.forEach(contact => {
                const li = document.createElement('li');
                li.className = 'contact-item';
                li.dataset.contactId = contact.id;
                li.innerHTML = `
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-company">${contact.company}</div>
                        <div>üìß ${contact.email || 'N/A'}</div>
                        <div>üìû ${contact.phone || 'N/A'}</div>
                        <div class="contact-channels">
                            ${contact.whatsapp ? '<span>üü¢ WhatsApp</span>' : ''}
                            ${contact.wechat ? '<span>üí¨ WeChat</span>' : ''}
                            ${contact.signal ? '<span>üîí Signal</span>' : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="project-action-btn" data-action="edit-contact">‚úèÔ∏è</button>
                        <button class="project-action-btn" data-action="delete-contact">üóëÔ∏è</button>
                    </div>
                `;
                contactListEl.appendChild(li);
            });
        }

        function renderInvoices() {
            const invoiceListEl = document.getElementById('invoice-list');
            invoiceListEl.innerHTML = '';
            if (allInvoices.length === 0) {
                invoiceListEl.innerHTML = '<li class="list-item">No invoices yet.</li>';
                return;
            }
            allInvoices.forEach(invoice => {
                const client = allContacts.find(c => c.id === invoice.contactId);
                const li = document.createElement('li');
                li.className = 'invoice-item';
                li.dataset.invoiceId = invoice.id;
                li.innerHTML = `
                    <div class="invoice-info">
                        <div class="invoice-client">${client ? client.name : 'Unknown Client'}</div>
                        <div class="invoice-details">
                            Amount: ‚Ç¨${invoice.amount} | Due: ${formatDateGerman(invoice.dueDate)}
                        </div>
                    </div>
                    <div class="item-actions">
                         <span class="status-badge status-${invoice.status.toLowerCase()}">${invoice.status}</span>
                        <button class="project-action-btn" data-action="edit-invoice">‚úèÔ∏è</button>
                        <button class="project-action-btn" data-action="delete-invoice">üóëÔ∏è</button>
                    </div>
                `;
                invoiceListEl.appendChild(li);
            });
        }

        function renderExpenses() {
            const expenseListEl = document.getElementById('expense-list');
            expenseListEl.innerHTML = '';
            if (allExpenses.length === 0) {
                expenseListEl.innerHTML = '<li class="list-item">No expenses yet.</li>';
                return;
            }
            allExpenses.forEach(expense => {
                const li = document.createElement('li');
                li.className = 'expense-item';
                li.dataset.expenseId = expense.id;
                li.innerHTML = `
                    <div class="expense-info">
                        <div class="expense-description">${expense.description}</div>
                        <div class="expense-details">
                            Amount: ‚Ç¨${expense.amount} | Date: ${formatDateGerman(expense.date)} | Category: ${expense.category}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="project-action-btn" data-action="edit-expense">‚úèÔ∏è</button>
                        <button class="project-action-btn" data-action="delete-expense">üóëÔ∏è</button>
                    </div>
                `;
                expenseListEl.appendChild(li);
            });
        }

        // --- EVENT LISTENERS ---
        document.getElementById('sidebar').addEventListener('click', (e) => {
            const newProjectBtn = e.target.closest('#new-project-btn');
            const actionTarget = e.target.closest('[data-action]');
            
            if (newProjectBtn) {
                showModal({
                    title: 'Create New Project',
                    inputs: [{ label: 'Project Name' }],
                    confirmText: 'Create'
                }).then(async ({ confirmed, inputs }) => {
                    if (confirmed && inputs[0]) {
                        await projectService.add({ name: inputs[0], parentId: currentProjectId || null });
                    }
                });
                return;
            }

            if (actionTarget) {
                const action = actionTarget.dataset.action;
                const projectItem = actionTarget.closest('.project-item');
                const projectId = projectItem.parentElement.dataset.id;
                const project = allProjects.find(p => p.id === projectId);

                switch (action) {
                    case 'select':
                        selectProject(projectId);
                        const sublist = projectItem.parentElement.querySelector('ul');
                        if (sublist) {
                            const isHidden = sublist.style.display === 'none';
                            sublist.style.display = isHidden ? 'block' : 'none';
                            projectItem.querySelector('.toggle').textContent = isHidden ? '‚ñº' : '‚ñ∂';
                            if (isHidden) expandedProjects.add(projectId);
                            else expandedProjects.delete(projectId);
                        }
                        break;
                    
                    case 'rename':
                        showModal({
                            title: `Rename "${project.name}"`,
                            inputs: [{ label: 'New Project Name', value: project.name }],
                            confirmText: 'Rename'
                        }).then(async ({ confirmed, inputs }) => {
                            if (confirmed && inputs[0]) {
                                await projectService.renameProject(projectId, inputs[0]);
                            }
                        });
                        break;

                    case 'delete':
                        showModal({
                            title: 'Delete Project',
                            message: `Are you sure you want to delete "${project.name}" and all its sub-projects? This action cannot be undone.`,
                            confirmText: 'Delete',
                            danger: true
                        }).then(async ({ confirmed }) => {
                            if (confirmed) {
                                await projectService.deleteProject(projectId);
                                if (currentProjectId === projectId) currentProjectId = null;
                            }
                        });
                        break;
                }
            }
        });
        
        document.getElementById('main-nav').addEventListener('click', (e) => {
            const clickedNavItem = e.target.closest('.main-nav-item');
            if (!clickedNavItem) return;

            document.querySelectorAll('.main-nav-item').forEach(item => item.classList.remove('active'));
            clickedNavItem.classList.add('active');

            document.querySelectorAll('.main-panel').forEach(panel => panel.classList.remove('active'));
            const panelId = clickedNavItem.dataset.panel;
            document.getElementById(panelId).classList.add('active');
        });

        document.getElementById('project-tabs').addEventListener('click', (e) => {
            const clickedTab = e.target.closest('.tab-button');
            if (!clickedTab) return;

            document.querySelectorAll('#project-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            clickedTab.classList.add('active');

            document.querySelectorAll('.tab-content-container .tab-panel').forEach(panel => panel.classList.remove('active'));
            const tabId = clickedTab.dataset.tab;
            document.getElementById(tabId).classList.add('active');
        });

        document.getElementById('add-document-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            showModal({
                title: 'Add New Document',
                inputs: [ { label: 'Document Name' }, { label: 'Document URL' } ],
                confirmText: 'Add'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0] && inputs[1]) {
                    const newDoc = { id: `doc_${crypto.randomUUID()}`, name: inputs[0], url: inputs[1] };
                    await projectService.updateProjectSubcollection(currentProjectId, 'documents', newDoc);
                }
            });
        });

        document.getElementById('add-member-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            const project = allProjects.find(p => p.id === currentProjectId);
            const memberOptions = allContacts
                .filter(c => !project.team.includes(c.id))
                .map(c => ({ value: c.id, text: c.name }));

            if (memberOptions.length === 0) {
                return alert("All available contacts are already on this team.");
            }

            showModal({
                title: 'Add Team Member',
                inputs: [{ label: 'Select Contact', type: 'select', options: memberOptions }],
                confirmText: 'Add'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    await projectService.addTeamMember(currentProjectId, inputs[0]);
                }
            });
        });

        teamListEl.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-btn');
            if (removeBtn) {
                const contactId = removeBtn.dataset.contactId;
                showModal({
                    title: 'Remove Team Member',
                    message: 'Are you sure you want to remove this member from the project?',
                    confirmText: 'Remove',
                    danger: true
                }).then(async ({ confirmed }) => {
                    if (confirmed) {
                        await projectService.removeTeamMember(currentProjectId, contactId);
                    }
                });
            }
        });
        
        document.getElementById('add-comm-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            showModal({
                title: 'Add Communication Log',
                inputs: [{ label: 'Log Message' }],
                confirmText: 'Add Log'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    const newLog = { id: `comm_${crypto.randomUUID()}`, message: inputs[0], timestamp: new Date().toISOString() };
                    await projectService.updateProjectSubcollection(currentProjectId, 'comms', newLog);
                }
            });
        });

        document.getElementById('add-task-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            const project = allProjects.find(p => p.id === currentProjectId);
            const teamContacts = allContacts.filter(c => project.team.includes(c.id));
            
            const assigneeOptions = [{ value: 'Me (Email)', text: 'Me (Email)' }];
            teamContacts.forEach(contact => {
                if(contact.whatsapp) assigneeOptions.push({ value: `${contact.name} (WhatsApp)`, text: `${contact.name} (WhatsApp)` });
                if(contact.wechat) assigneeOptions.push({ value: `${contact.name} (WeChat)`, text: `${contact.name} (WeChat)` });
                if(contact.signal) assigneeOptions.push({ value: `${contact.name} (Signal)`, text: `${contact.name} (Signal)` });
                if(contact.email) assigneeOptions.push({ value: `${contact.name} (Email)`, text: `${contact.name} (Email)` });
            });

            const priorityOptions = [
                { value: 'low', text: 'Low' }, { value: 'medium', text: 'Medium' }, { value: 'high', text: 'High' }
            ];

            showModal({
                title: 'Add New Task',
                inputs: [
                    { label: 'Task Name' },
                    { label: 'Assign To', type: 'select', options: assigneeOptions },
                    { label: 'Priority', type: 'select', options: priorityOptions },
                    { label: 'Start Date', type: 'date' },
                    { label: 'End Date', type: 'date' }
                ],
                confirmText: 'Add Task'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    const [name, assignee, priority, startDate, endDate] = inputs;
                    await projectService.addTask(currentProjectId, { name, assignee, priority, startDate, endDate, description: '' });
                }
            });
        });

        const kanbanBoard = document.querySelector('.kanban-board');
        let draggedTask = null;

        kanbanBoard.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('task-card')) {
                draggedTask = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }
        });

        kanbanBoard.addEventListener('dragend', (e) => {
            if (draggedTask) {
                draggedTask.classList.remove('dragging');
                draggedTask = null;
            }
        });
        
        kanbanBoard.addEventListener('dragover', (e) => {
            e.preventDefault();
            const dropZone = e.target.closest('.kanban-tasks');
            if (dropZone) dropZone.classList.add('drag-over');
        });

        kanbanBoard.addEventListener('dragleave', (e) => {
            const dropZone = e.target.closest('.kanban-tasks');
            if (dropZone) dropZone.classList.remove('drag-over');
        });

        kanbanBoard.addEventListener('drop', async (e) => {
            e.preventDefault();
            const dropZone = e.target.closest('.kanban-tasks');
            if (dropZone) {
                dropZone.classList.remove('drag-over');
                const column = dropZone.closest('.kanban-column');
                if (column && draggedTask) {
                    const newStatus = column.dataset.status;
                    const taskId = draggedTask.dataset.taskId;
                    
                    await projectService.updateTaskStatus(currentProjectId, taskId, newStatus);
                }
            }
        });

        kanbanBoard.addEventListener('click', (e) => {
            const taskCard = e.target.closest('.task-card');
            if (!taskCard) return;
            
            const taskId = taskCard.dataset.taskId;
            const project = allProjects.find(p => p.id === currentProjectId);
            const task = project.tasks.find(t => t.id === taskId);
            
             const teamContacts = allContacts.filter(c => project.team.includes(c.id));
            const assigneeOptions = [{ value: 'Me (Email)', text: 'Me (Email)' }];
            teamContacts.forEach(contact => {
                if(contact.whatsapp) assigneeOptions.push({ value: `${contact.name} (WhatsApp)`, text: `${contact.name} (WhatsApp)` });
                if(contact.wechat) assigneeOptions.push({ value: `${contact.name} (WeChat)`, text: `${contact.name} (WeChat)` });
                if(contact.signal) assigneeOptions.push({ value: `${contact.name} (Signal)`, text: `${contact.name} (Signal)` });
                if(contact.email) assigneeOptions.push({ value: `${contact.name} (Email)`, text: `${contact.name} (Email)` });
            });

            const priorityOptions = [
                { value: 'low', text: 'Low' }, { value: 'medium', text: 'Medium' }, { value: 'high', text: 'High' }
            ];

             showModal({
                title: 'Edit Task',
                inputs: [
                    { label: 'Task Name', value: task.name },
                    { label: 'Assign To', type: 'select', options: assigneeOptions, value: task.assignee },
                    { label: 'Priority', type: 'select', options: priorityOptions, value: task.priority },
                    { label: 'Start Date', type: 'date', value: task.startDate },
                    { label: 'End Date', type: 'date', value: task.endDate },
                    { label: 'Description', type: 'textarea', value: task.description }
                ],
                confirmText: 'Save Changes'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed) {
                    const [name, assignee, priority, startDate, endDate, description] = inputs;
                    await projectService.updateTask(currentProjectId, taskId, { name, assignee, priority, startDate, endDate, description });
                }
            });
        });

        document.getElementById('add-contact-btn').addEventListener('click', () => {
            showModal({
                title: 'Add New Contact',
                inputs: [
                    { label: 'Name' }, { label: 'Email' }, { label: 'Phone' }, { label: 'Company' },
                    { label: 'WhatsApp' }, { label: 'WeChat' }, { label: 'Signal' }
                ],
                confirmText: 'Save Contact'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    const [name, email, phone, company, whatsapp, wechat, signal] = inputs;
                    await contactService.add({ name, email, phone, company, whatsapp, wechat, signal });
                }
            });
        });

        document.getElementById('contact-list').addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const action = actionTarget.dataset.action;
            const contactItem = actionTarget.closest('.contact-item');
            const contactId = contactItem.dataset.contactId;
            const contact = allContacts.find(c => c.id === contactId);

            if (action === 'edit-contact') {
                showModal({
                    title: 'Edit Contact',
                    inputs: [
                        { label: 'Name', value: contact.name },
                        { label: 'Email', value: contact.email },
                        { label: 'Phone', value: contact.phone },
                        { label: 'Company', value: contact.company },
                        { label: 'WhatsApp', value: contact.whatsapp },
                        { label: 'WeChat', value: contact.wechat },
                        { label: 'Signal', value: contact.signal }
                    ],
                    confirmText: 'Save Changes'
                }).then(async ({ confirmed, inputs }) => {
                    if (confirmed) {
                        const [name, email, phone, company, whatsapp, wechat, signal] = inputs;
                        await contactService.update(contactId, { name, email, phone, company, whatsapp, wechat, signal });
                    }
                });
            } else if (action === 'delete-contact') {
                showModal({
                    title: 'Delete Contact',
                    message: `Are you sure you want to delete ${contact.name}?`,
                    confirmText: 'Delete',
                    danger: true
                }).then(async ({ confirmed }) => {
                    if (confirmed) {
                        await contactService.delete(contactId);
                    }
                });
            }
        });
        
        document.getElementById('create-invoice-btn').addEventListener('click', () => {
            if (allContacts.length === 0) {
                return alert("Please add a contact before creating an invoice.");
            }
            const contactOptions = allContacts.map(c => ({ value: c.id, text: c.name }));
            const statusOptions = [
                { value: 'Draft', text: 'Draft' }, { value: 'Sent', text: 'Sent' }, { value: 'Paid', text: 'Paid' }
            ];
            showModal({
                title: 'Create New Invoice',
                inputs: [
                    { label: 'Client', type: 'select', options: contactOptions },
                    { label: 'Amount (‚Ç¨)', type: 'number' },
                    { label: 'Due Date', type: 'date' },
                    { label: 'Status', type: 'select', options: statusOptions }
                ],
                confirmText: 'Create Invoice'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    const [contactId, amount, dueDate, status] = inputs;
                    await invoiceService.add({ contactId, amount, dueDate, status });
                }
            });
        });

        document.getElementById('invoice-list').addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const action = actionTarget.dataset.action;
            const invoiceItem = actionTarget.closest('.invoice-item');
            const invoiceId = invoiceItem.dataset.invoiceId;
            const invoice = allInvoices.find(i => i.id === invoiceId);

            if (action === 'edit-invoice') {
                 const contactOptions = allContacts.map(c => ({ value: c.id, text: c.name }));
                const statusOptions = [
                    { value: 'Draft', text: 'Draft' }, { value: 'Sent', text: 'Sent' }, { value: 'Paid', text: 'Paid' }
                ];
                showModal({
                    title: 'Edit Invoice',
                    inputs: [
                        { label: 'Client', type: 'select', options: contactOptions, value: invoice.contactId },
                        { label: 'Amount (‚Ç¨)', type: 'number', value: invoice.amount },
                        { label: 'Due Date', type: 'date', value: invoice.dueDate },
                        { label: 'Status', type: 'select', options: statusOptions, value: invoice.status }
                    ],
                    confirmText: 'Save Changes'
                }).then(async ({ confirmed, inputs }) => {
                    if (confirmed) {
                        const [contactId, amount, dueDate, status] = inputs;
                        await invoiceService.update(invoiceId, { contactId, amount, dueDate, status });
                    }
                });
            } else if (action === 'delete-invoice') {
                showModal({
                    title: 'Delete Invoice',
                    message: 'Are you sure you want to delete this invoice?',
                    confirmText: 'Delete',
                    danger: true
                }).then(async ({ confirmed }) => {
                    if (confirmed) {
                        await invoiceService.delete(invoiceId);
                    }
                });
            }
        });

        document.getElementById('add-expense-btn').addEventListener('click', () => {
            const categoryOptions = [
                { value: 'Travel', text: 'Travel (Flug, Bahn, etc.)' },
                { value: 'Hotel', text: 'Hotel' },
                { value: 'Restaurant', text: 'Restaurant / Bewirtung' },
                { value: 'Office Supplies', text: 'Office Supplies' },
                { value: 'Other', text: 'Other' }
            ];
            showModal({
                title: 'Add New Expense',
                inputs: [
                    { label: 'Description (e.g., "Flight to Berlin")' },
                    { label: 'Amount (‚Ç¨)', type: 'number' },
                    { label: 'Date', type: 'date' },
                    { label: 'Category', type: 'select', options: categoryOptions }
                ],
                confirmText: 'Add Expense'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    const [description, amount, date, category] = inputs;
                    await expenseService.add({ description, amount, date, category });
                }
            });
        });

        document.getElementById('expense-list').addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const action = actionTarget.dataset.action;
            const expenseItem = actionTarget.closest('.expense-item');
            const expenseId = expenseItem.dataset.expenseId;
            const expense = allExpenses.find(ex => ex.id === expenseId);

            if (action === 'edit-expense') {
                const categoryOptions = [
                    { value: 'Travel', text: 'Travel (Flug, Bahn, etc.)' },
                    { value: 'Hotel', text: 'Hotel' },
                    { value: 'Restaurant', text: 'Restaurant / Bewirtung' },
                    { value: 'Office Supplies', text: 'Office Supplies' },
                    { value: 'Other', text: 'Other' }
                ];
                 showModal({
                    title: 'Edit Expense',
                    inputs: [
                        { label: 'Description', value: expense.description },
                        { label: 'Amount (‚Ç¨)', type: 'number', value: expense.amount },
                        { label: 'Date', type: 'date', value: expense.date },
                        { label: 'Category', type: 'select', options: categoryOptions, value: expense.category }
                    ],
                    confirmText: 'Save Changes'
                }).then(async ({ confirmed, inputs }) => {
                    if (confirmed) {
                        const [description, amount, date, category] = inputs;
                        await expenseService.update(expenseId, { description, amount, date, category });
                    }
                });
            } else if (action === 'delete-expense') {
                showModal({
                    title: 'Delete Expense',
                    message: 'Are you sure you want to delete this expense?',
                    confirmText: 'Delete',
                    danger: true
                }).then(async ({ confirmed }) => {
                    if (confirmed) {
                        await expenseService.delete(expenseId);
                    }
                });
            }
        });

         document.getElementById('export-expenses-btn').addEventListener('click', () => {
            showModal({
                title: 'Export Expense Report',
                inputs: [{
                    label: 'Select Period',
                    type: 'select',
                    options: [
                        { value: 'week', text: 'This Week' },
                        { value: 'month', text: 'This Month' },
                        { value: 'year', text: 'This Year' }
                    ]
                }],
                confirmText: 'Download CSV'
            }).then(({ confirmed, inputs }) => {
                if (confirmed) {
                    exportExpenses(inputs[0]);
                }
            });
        });

        function exportExpenses(period) {
            const now = new Date();
            let startDate;

            if (period === 'week') {
                startDate = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))); // Monday of current week
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else { // year
                startDate = new Date(now.getFullYear(), 0, 1);
            }
            startDate.setHours(0,0,0,0);

            const filteredExpenses = allExpenses.filter(ex => new Date(ex.date) >= startDate);

            if (filteredExpenses.length === 0) {
                return alert('No expenses found for the selected period.');
            }

            const headers = ['Date', 'Description', 'Category', 'Amount'];
            const rows = filteredExpenses.map(ex => [
                formatDateGerman(ex.date),
                `"${ex.description.replace(/"/g, '""')}"`, // Handle quotes
                ex.category,
                ex.amount
            ]);

            let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(',') + '\n' 
                + rows.map(e => e.join(',')).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `expenses_${period}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Calendar Navigation
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentCalendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            } else if (currentCalendarView === 'year') {
                currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() - 1);
            } else if (currentCalendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
            }
            renderCalendar();
        });
        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentCalendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            } else if (currentCalendarView === 'year') {
                currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() + 1);
            } else if (currentCalendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
            }
            renderCalendar();
        });
        document.getElementById('calendar-view-controls').addEventListener('click', (e) => {
            const view = e.target.dataset.view;
            if(view) {
                currentCalendarView = view;
                renderCalendar();
            }
        });

        document.getElementById('calendar-grid').addEventListener('click', (e) => {
            const dayCell = e.target.closest('.calendar-day');
            if (!dayCell) return;
            const date = dayCell.dataset.date;
            showAppointmentModal({ date });
        });

        document.getElementById('add-appointment-btn').addEventListener('click', () => {
            showAppointmentModal({});
        });

        function showAppointmentModal(eventData) {
            const contactOptions = allContacts.map(c => ({ value: c.id, text: c.name }));
            showModal({
                title: eventData.id ? 'Edit Appointment' : 'New Appointment',
                inputs: [
                    { label: 'Title', value: eventData.title || '' },
                    { label: 'Date', type: 'date', value: eventData.date || '' },
                    { label: 'Start Time', type: 'time', value: eventData.startTime || '' },
                    { label: 'End Time', type: 'time', value: eventData.endTime || '' },
                    { label: 'Attendees', type: 'select', options: contactOptions, value: eventData.attendee || '' }
                ],
                confirmText: eventData.id ? 'Save Changes' : 'Create'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    const [title, date, startTime, endTime, attendee] = inputs;
                    const event = { title, date, startTime, endTime, attendee };
                    if (eventData.id) {
                        await eventService.update(eventData.id, event);
                    } else {
                        await eventService.add(event);
                    }
                }
            });
        }

        // --- AUTHENTICATION ---
        let isLogin = true;

        authToggle.addEventListener('click', () => {
            isLogin = !isLogin;
            authTitle.textContent = isLogin ? 'Login' : 'Sign Up';
            authSubmitBtn.textContent = isLogin ? 'Login' : 'Sign Up';
            authToggle.textContent = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
            authError.textContent = '';
        });

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = authEmail.value;
            const password = authPassword.value;
            authError.textContent = '';

            if (isLogin) {
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => authError.textContent = error.message);
            } else {
                createUserWithEmailAndPassword(auth, email, password)
                    .catch(error => authError.textContent = error.message);
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- INITIALIZATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                currentUserId = user.uid;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                const collections = ['projects', 'contacts', 'invoices', 'expenses', 'events'];
                collections.forEach(coll => {
                    const unsub = onSnapshot(getCollectionRef(coll), snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        window[`all${coll.charAt(0).toUpperCase() + coll.slice(1)}`] = data;
                        
                        // Re-render relevant parts of the UI
                        if (coll === 'projects') renderProjectTree();
                        if (coll === 'contacts') { renderContacts(); renderInvoices(); }
                        if (coll === 'invoices') renderInvoices();
                        if (coll === 'expenses') renderExpenses();
                        if (coll === 'events') renderCalendar();
                        
                        if (currentProjectId) selectProject(currentProjectId);
                    });
                    unsubscribeListeners.push(unsub);
                });

                initializeAppState();

            } else {
                // User is signed out.
                currentUserId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
                allProjects = []; allContacts = []; allInvoices = []; allExpenses = []; allEvents = [];
            }
        });

        async function initializeAppState() {
            const projectsSnapshot = await getDocs(getCollectionRef('projects'));
            let needsSave = false;
            const batch = writeBatch(db);
            projectsSnapshot.docs.forEach(doc => {
                const project = {id: doc.id, ...doc.data()};
                if (!project.icon) {
                    const newIcon = getIconForProjectName(project.name);
                    batch.update(doc.ref, { icon: newIcon });
                    needsSave = true;
                }
            });
            if (needsSave) await batch.commit();


            if (projectsSnapshot.empty) {
                 await projectService.add({ name: 'Main Project Alpha' });
            } else {
                if (!currentProjectId || !allProjects.some(p => p.id === currentProjectId)) {
                    const firstProjectId = allProjects.find(p => !p.parentId)?.id || allProjects[0]?.id;
                    if (firstProjectId) selectProject(firstProjectId);
                }
            }
        }
    </script>
</body>
</html>
