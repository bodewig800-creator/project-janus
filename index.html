<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Janus</title>
    <style>
        body { font-family: sans-serif; display: flex; padding: 20px; background-color: #f9f9f9; margin: 0; }
        #sidebar { width: 300px; border: 1px solid #ccc; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        /* Main Navigation Styles */
        #main-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .main-nav-item {
            padding: 12px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        .main-nav-item:hover {
            background-color: #f0f0f0;
        }
        .main-nav-item.active {
            background-color: #e0e0ff;
            font-weight: bold;
        }
        #project-tree-container {
            padding-left: 20px;
        }

        #project-tree { list-style: none; padding: 0; margin-top: 10px; }
        #project-tree ul { list-style: none; padding-left: 20px; }
        .project-item { 
            padding: 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; 
        }
        .project-item:hover { background-color: #f0f0f0; }
        .project-item.active { background-color: #d0d0ff; }
        .project-name-wrapper { display: flex; align-items: center; flex-grow: 1; min-width: 0; }
        .project-name-wrapper span:last-child { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toggle { margin-right: 8px; width: 16px; text-align: center; font-size: 10px; user-select: none; }
        .project-icon { margin-right: 8px; }
        
        .sidebar-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .sidebar-actions button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        .project-actions {
            display: none;
            gap: 5px;
        }
        .project-item:hover .project-actions {
            display: flex;
        }
        .project-action-btn {
            background: none; border: none; cursor: pointer; font-size: 14px; padding: 2px 4px;
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 20px 30px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 450px;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 15px;
            box-sizing: border-box;
        }
        .modal-content textarea { min-height: 80px; resize: vertical; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-actions button {
            padding: 8px 15px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer;
        }
        .modal-actions button[type="submit"] {
            background-color: #4a90e2; border-color: #4a90e2; color: white;
        }
        .modal-actions .confirm-danger {
             background-color: #d9534f; border-color: #d9534f; color: white;
        }
        .hidden { display: none; }

        /* Tab Styles */
        .tab-container {
            display: flex;
            border-bottom: 2px solid #ccc;
            margin-top: 20px;
        }
        .tab-button {
            padding: 10px 20px; border: none; background-color: transparent; cursor: pointer;
            font-size: 16px; border-bottom: 2px solid transparent; margin-bottom: -2px;
        }
        .tab-button:hover { background-color: #f0f0f0; }
        .tab-button.active { border-color: #007bff; font-weight: bold; }
        
        .main-panel, .tab-panel { display: none; }
        .main-panel.active, .tab-panel.active { display: block; }
        
        .tab-panel { padding-top: 20px; }
        .panel-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee;
        }
        .remove-btn {
            background: none; border: none; color: red; cursor: pointer; font-size: 16px;
        }
        .comm-log-item small { color: #666; margin-left: 15px; flex-shrink: 0; }

        /* Kanban Styles */
        .kanban-board { display: flex; gap: 20px; width: 100%; overflow-x: auto; }
        .kanban-column {
            flex: 1; min-width: 250px; background-color: #f4f5f7; border-radius: 8px; padding: 10px;
        }
        .kanban-column h4 { margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #ccc; }
        .kanban-tasks { min-height: 200px; display: flex; flex-direction: column; gap: 10px; }
        .task-card {
            background-color: #fff; padding: 15px; border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: grab; border-left: 5px solid transparent;
        }
        .task-card.priority-high { border-left-color: #d9534f; }
        .task-card.priority-medium { border-left-color: #f0ad4e; }
        .task-card.priority-low { border-left-color: #5cb85c; }
        .task-card .task-name { font-weight: bold; margin-bottom: 10px; }
        .task-card .task-details { font-size: 12px; color: #555; }
        .task-card.dragging { opacity: 0.5; }
        .drag-over { background-color: #e0e0ff; }
        
        /* Calendar Styles */
        #calendar-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day {
            border: 1px solid #ccc; min-height: 100px; padding: 5px; background-color: #fff;
        }
        .calendar-day-header { font-weight: bold; text-align: center; padding-bottom: 5px; }
        .calendar-day-number { font-size: 12px; color: #555; }
        .calendar-task {
            font-size: 11px; padding: 2px 4px; border-radius: 3px; background-color: #e0e0ff;
            margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        /* Contacts Styles */
        #contact-list { list-style: none; padding: 0; }
        .contact-item {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .contact-info div { margin-bottom: 5px; }
        .contact-info .contact-name { font-weight: bold; }
        .contact-info .contact-company { color: #555; font-style: italic; }
        .contact-channels { font-size: 12px; color: #777; }
        .contact-channels span { margin-right: 5px; }
        .contact-actions { display: flex; gap: 10px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Janus</h2>
        <ul id="main-nav">
            <li class="main-nav-item active" data-panel="project-panel">üìÅ Projects</li>
            <div id="project-tree-container">
                 <div class="sidebar-actions">
                    <button id="new-project-btn">New Project</button>
                </div>
                <p><small>Select a project to create a sub-project under it.</small></p>
                <ul id="project-tree"></ul>
            </div>
            <li class="main-nav-item" data-panel="calendar-panel">üìÖ Calendar</li>
            <li class="main-nav-item" data-panel="contacts-panel">üë• Contacts</li>
            <li class="main-nav-item" data-panel="invoices-panel">üßæ Invoices</li>
        </ul>
    </div>
    
    <div id="main-content" style="padding-left: 20px; flex-grow: 1;">
        <div class="main-panel active" id="project-panel">
            <h3>Selected Project:</h3>
            <p id="current-project-name">None</p>
        
            <div class="tab-container" id="project-tabs">
                <button class="tab-button active" data-tab="tasks-panel">Tasks</button>
                <button class="tab-button" data-tab="documents-panel">Documents</button>
                <button class="tab-button" data-tab="communication-panel">Communication</button>
                <button class="tab-button" data-tab="team-panel">Team</button>
            </div>
        
            <div class="tab-content-container">
                <div class="tab-panel active" id="tasks-panel">
                     <div class="panel-header">
                        <h4>Task Board</h4>
                        <button id="add-task-btn">New Task</button>
                    </div>
                    <div class="kanban-board">
                        <div class="kanban-column" data-status="mytodo">
                            <h4>My To Do</h4>
                            <div class="kanban-tasks"></div>
                        </div>
                         <div class="kanban-column" data-status="assignedtodo">
                            <h4>Assigned To Do</h4>
                            <div class="kanban-tasks"></div>
                        </div>
                        <div class="kanban-column" data-status="inprogress">
                            <h4>In Progress</h4>
                            <div class="kanban-tasks"></div>
                        </div>
                        <div class="kanban-column" data-status="done">
                            <h4>Done</h4>
                            <div class="kanban-tasks"></div>
                        </div>
                    </div>
                </div>
        
                <div class="tab-panel" id="documents-panel">
                    <div class="panel-header">
                        <h4>Project Documents</h4>
                        <button id="add-document-btn">Add Document</button>
                    </div>
                    <ul id="document-list"></ul>
                </div>
        
                <div class="tab-panel" id="communication-panel">
                    <div class="panel-header">
                        <h4>Communication Log</h4>
                        <button id="add-comm-btn">Add Log Entry</button>
                    </div>
                    <ul id="comm-list"></ul>
                </div>
        
                <div class="tab-panel" id="team-panel">
                    <div class="panel-header">
                        <h4>Team Members</h4>
                        <button id="add-member-btn">Add Member</button>
                    </div>
                    <ul id="team-list"></ul>
                </div>
            </div>
        </div>
        <div class="main-panel" id="calendar-panel">
            <div id="calendar-header">
                <button id="prev-month-btn">&lt;</button>
                <h3 id="month-year-display">Month Year</h3>
                <button id="next-month-btn">&gt;</button>
            </div>
            <div id="calendar-grid"></div>
        </div>
        <div class="main-panel" id="contacts-panel">
            <div class="panel-header">
                <h2>Contacts (CRM)</h2>
                <button id="add-contact-btn">Add Contact</button>
            </div>
            <ul id="contact-list"></ul>
        </div>
        <div class="main-panel" id="invoices-panel">
            <div class="panel-header">
                <h2>Invoices</h2>
                <button>Create Invoice</button>
            </div>
            <p>Invoice management system will be built here.</p>
        </div>
    </div>

    <!-- Generic Reusable Modal -->
    <div id="generic-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="modal-title">Title</h3>
            <p id="modal-message" class="hidden"></p>
            <form id="modal-form">
                <div id="modal-input-container">
                    <!-- JS will generate inputs here -->
                </div>
                <div class="modal-actions">
                    <button type="button" id="modal-cancel-btn">Cancel</button>
                    <button type="submit" id="modal-confirm-btn">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- DATA STORE ---
        const projectService = {
            getAll: async () => JSON.parse(localStorage.getItem('janus_projects')) || [],
            saveAll: async (projects) => localStorage.setItem('janus_projects', JSON.stringify(projects)),
            add: async (data) => {
                const projects = await projectService.getAll();
                const newProject = { 
                    id: `proj_${crypto.randomUUID()}`, 
                    documents: [], team: [], comms: [], tasks: [],
                    icon: getIconForProjectName(data.name),
                    ...data 
                };
                projects.push(newProject);
                await projectService.saveAll(projects);
                return newProject;
            },
            deleteProject: async (projectId) => {
                let projects = await projectService.getAll();
                const projectsToDelete = new Set([projectId]);
                let changed = true;
                while (changed) {
                    changed = false;
                    const children = projects.filter(p => projectsToDelete.has(p.parentId));
                    children.forEach(child => {
                        if (!projectsToDelete.has(child.id)) {
                            projectsToDelete.add(child.id);
                            changed = true;
                        }
                    });
                }
                const remainingProjects = projects.filter(p => !projectsToDelete.has(p.id));
                await projectService.saveAll(remainingProjects);
            },
            renameProject: async (projectId, newName) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    project.name = newName;
                    project.icon = getIconForProjectName(newName);
                    await projectService.saveAll(projects);
                }
            },
            addDocument: async (projectId, docData) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return null;
                const newDocument = { id: `doc_${crypto.randomUUID()}`, ...docData };
                project.documents.push(newDocument);
                await projectService.saveAll(projects);
                return newDocument;
            },
            addTeamMember: async (projectId, contactId) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return null;
                if (!project.team.includes(contactId)) {
                    project.team.push(contactId);
                    await projectService.saveAll(projects);
                }
            },
            removeTeamMember: async (projectId, contactId) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return;
                project.team = project.team.filter(id => id !== contactId);
                await projectService.saveAll(projects);
            },
            addCommLog: async (projectId, message) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return null;
                const newLog = { 
                    id: `comm_${crypto.randomUUID()}`, 
                    message,
                    timestamp: new Date().toISOString()
                };
                project.comms.unshift(newLog);
                await projectService.saveAll(projects);
                return newLog;
            },
            addTask: async (projectId, taskData) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return null;
                const newTask = {
                    id: `task_${crypto.randomUUID()}`,
                    status: taskData.assignee.startsWith('Me') ? 'mytodo' : 'assignedtodo',
                    ...taskData
                };
                project.tasks.push(newTask);
                await projectService.saveAll(projects);
                return newTask;
            },
            updateTask: async (projectId, taskId, updatedData) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return;
                const taskIndex = project.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) {
                    project.tasks[taskIndex] = { ...project.tasks[taskIndex], ...updatedData };
                    await projectService.saveAll(projects);
                }
            },
            updateTaskStatus: async (projectId, taskId, newStatus) => {
                const projects = await projectService.getAll();
                const project = projects.find(p => p.id === projectId);
                if (!project) return;
                const task = project.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = newStatus;
                    await projectService.saveAll(projects);
                }
            }
        };

        const contactService = {
            getAll: async () => JSON.parse(localStorage.getItem('janus_contacts')) || [],
            saveAll: async (contacts) => localStorage.setItem('janus_contacts', JSON.stringify(contacts)),
            add: async (contactData) => {
                const contacts = await contactService.getAll();
                const newContact = { id: `con_${crypto.randomUUID()}`, ...contactData };
                contacts.push(newContact);
                await contactService.saveAll(contacts);
                return newContact;
            },
            update: async (contactId, updatedData) => {
                const contacts = await contactService.getAll();
                const contactIndex = contacts.findIndex(c => c.id === contactId);
                if (contactIndex > -1) {
                    contacts[contactIndex] = { ...contacts[contactIndex], ...updatedData };
                    await contactService.saveAll(contacts);
                }
            },
            delete: async (contactId) => {
                let contacts = await contactService.getAll();
                contacts = contacts.filter(c => c.id !== contactId);
                await contactService.saveAll(contacts);
            }
        };

        // --- GLOBAL STATE ---
        let allProjects = [];
        let allContacts = [];
        let currentProjectId = null;
        let expandedProjects = new Set();
        const teamListEl = document.getElementById('team-list');
        let currentCalendarDate = new Date();
        
        // Modal Elements
        const modal = document.getElementById('generic-modal');
        const modalForm = document.getElementById('modal-form');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        let modalResolve = null;

        // --- HELPER FUNCTIONS ---
        function formatDateGerman(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function getIconForProjectName(name) {
            const lowerName = name.toLowerCase();
            const iconMap = {
                'germany': 'üá©üá™', 'deutschland': 'üá©üá™', 'usa': 'üá∫üá∏', 'america': 'üá∫üá∏',
                'france': 'üá´üá∑', 'spain': 'üá™üá∏', 'italy': 'üáÆüáπ', 'uk': 'üá¨üáß', 'england': 'üá¨üáß',
                'canada': 'üá®üá¶', 'australia': 'üá¶üá∫', 'japan': 'üáØüáµ', 'china': 'üá®üá≥',
                'india': 'üáÆüá≥', 'brazil': 'üáßüá∑', 'africa': 'üåç', 'europe': 'üá™üá∫', 'asia': 'üåè',
                'marketing': 'üìà', 'finance': 'üí∞', 'development': 'üíª', 'dev': 'üíª', 'code': 'üíª',
                'design': 'üé®', 'sales': 'ü§ù', 'hr': 'üë•', 'human resources': 'üë•',
                'personal': 'üë§', 'home': 'üè†', 'work': 'üíº'
            };
            for (const key in iconMap) {
                if (lowerName.includes(key)) return iconMap[key];
            }
            return 'üìÅ';
        }

        // --- MODAL FUNCTIONS ---
        function showModal(options) {
            modalTitle.textContent = options.title;
            
            modalMessage.textContent = options.message || '';
            modalMessage.classList.toggle('hidden', !options.message);

            modalInputContainer.innerHTML = '';
            if (options.inputs) {
                options.inputs.forEach((input, index) => {
                    const id = `modal-input-${index}`;
                    const group = document.createElement('div');
                    const label = document.createElement('label');
                    label.htmlFor = id;
                    label.textContent = input.label;
                    group.appendChild(label);

                    if (input.type === 'select') {
                        const select = document.createElement('select');
                        select.id = id;
                        input.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.text;
                            if (opt.value === input.value) option.selected = true;
                            select.appendChild(option);
                        });
                        group.appendChild(select);
                    } else if (input.type === 'textarea') {
                        const textarea = document.createElement('textarea');
                        textarea.id = id;
                        textarea.value = input.value || '';
                        group.appendChild(textarea);
                    } else {
                        const inputEl = document.createElement('input');
                        inputEl.type = input.type || 'text';
                        inputEl.id = id;
                        inputEl.value = input.value || '';
                        inputEl.autocomplete = 'off';
                        group.appendChild(inputEl);
                    }
                    modalInputContainer.appendChild(group);
                });
            }

            modalConfirmBtn.textContent = options.confirmText || 'Confirm';
            modalConfirmBtn.className = options.danger ? 'confirm-danger' : '';

            modal.classList.remove('hidden');
            if (options.inputs) modalInputContainer.querySelector('input, select, textarea')?.focus();

            return new Promise(resolve => {
                modalResolve = resolve;
            });
        }

        function hideModal() {
            modal.classList.add('hidden');
            modalForm.reset();
            modalResolve = null;
        }

        modalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (modalResolve) {
                const inputs = Array.from(modalInputContainer.querySelectorAll('input, select, textarea')).map(el => el.value.trim());
                modalResolve({ confirmed: true, inputs });
                hideModal();
            }
        });

        modalCancelBtn.addEventListener('click', () => {
             if (modalResolve) {
                modalResolve({ confirmed: false });
                hideModal();
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal && modalResolve) {
                modalResolve({ confirmed: false });
                hideModal();
            }
        });

        // --- CORE RENDER FUNCTIONS ---
        async function renderProjectTree() {
            allProjects = await projectService.getAll();
            const treeEl = document.getElementById('project-tree');
            treeEl.innerHTML = '';
            const projectMap = new Map(allProjects.map(p => [p.id, { ...p, children: [] }]));
            const rootProjects = [];
            projectMap.forEach(project => {
                if (project.parentId && projectMap.has(project.parentId)) {
                    projectMap.get(project.parentId).children.push(project);
                } else {
                    rootProjects.push(project);
                }
            });
            rootProjects.sort((a,b) => a.name.localeCompare(b.name)).forEach(project => {
                treeEl.appendChild(createProjectNode(project));
            });
        }

        function createProjectNode(project) {
            const li = document.createElement('li');
            li.dataset.id = project.id;
            const hasChildren = project.children && project.children.length > 0;
            const projectItemDiv = document.createElement('div');
            projectItemDiv.className = 'project-item';
            
            if (project.id === currentProjectId) projectItemDiv.classList.add('active');
            projectItemDiv.innerHTML = `
                <div class="project-name-wrapper" data-action="select">
                    <span class="toggle">${hasChildren ? '‚ñ∂' : '‚Ä¢'}</span>
                    <span class="project-icon">${project.icon || 'üìÅ'}</span>
                    <span>${project.name}</span>
                </div>
                <div class="project-actions">
                    <button class="project-action-btn" data-action="rename" title="Rename Project">‚úèÔ∏è</button>
                    <button class="project-action-btn" data-action="delete" title="Delete Project">üóëÔ∏è</button>
                </div>
            `;
            li.appendChild(projectItemDiv);
            if (hasChildren) {
                const ul = document.createElement('ul');
                ul.style.display = expandedProjects.has(project.id) ? 'block' : 'none';
                projectItemDiv.querySelector('.toggle').textContent = expandedProjects.has(project.id) ? '‚ñº' : '‚ñ∂';
                project.children.sort((a,b) => a.name.localeCompare(b.name)).forEach(child => {
                    ul.appendChild(createProjectNode(child));
                });
                li.appendChild(ul);
            }
            return li;
        }
        
        function addProjectNodeToDOM(project) {
            const newNode = createProjectNode({ ...project, children: [] });
            let parentElement;
            if (project.parentId) {
                const parentLi = document.querySelector(`li[data-id="${project.parentId}"]`);
                parentElement = parentLi.querySelector('ul');
                if (!parentElement) {
                    parentElement = document.createElement('ul');
                    parentLi.appendChild(parentElement);
                    parentLi.querySelector('.toggle').textContent = '‚ñ∂'; 
                }
                parentElement.style.display = 'block';
                parentLi.querySelector('.toggle').textContent = '‚ñº';
            } else {
                parentElement = document.getElementById('project-tree');
            }
            parentElement.appendChild(newNode);
            const children = Array.from(parentElement.children);
            children.sort((a, b) => a.textContent.trim().localeCompare(b.textContent.trim()));
            children.forEach(child => parentElement.appendChild(child));
        }

        function selectProject(projectId) {
            currentProjectId = projectId;
            const project = allProjects.find(p => p.id === projectId);
            document.getElementById('current-project-name').textContent = project ? project.name : 'None';
            
            renderDocuments(projectId);
            renderTeam(projectId);
            renderComms(projectId);
            renderTasks(projectId);
            
            renderProjectTree();
        }

        function renderDocuments(projectId) {
            const documentListEl = document.getElementById('document-list');
            documentListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.documents || project.documents.length === 0) {
                documentListEl.innerHTML = '<li class="list-item">No documents yet.</li>';
                return;
            }
            project.documents.forEach(doc => {
                const li = document.createElement('li');
                li.className = 'list-item';
                const a = document.createElement('a');
                a.href = doc.url;
                a.textContent = doc.name;
                a.target = '_blank';
                li.appendChild(a);
                documentListEl.appendChild(li);
            });
        }

        function renderTeam(projectId) {
            teamListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.team || project.team.length === 0) {
                teamListEl.innerHTML = '<li class="list-item">No team members assigned.</li>';
                return;
            }
            project.team.forEach(contactId => {
                const contact = allContacts.find(c => c.id === contactId);
                if (contact) {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <span>${contact.name}</span>
                        <button class="remove-btn" data-contact-id="${contact.id}">&times;</button>
                    `;
                    teamListEl.appendChild(li);
                }
            });
        }

        function renderComms(projectId) {
            const commListEl = document.getElementById('comm-list');
            commListEl.innerHTML = '';
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.comms || project.comms.length === 0) {
                commListEl.innerHTML = '<li class="list-item">No communication logs.</li>';
                return;
            }
            project.comms.forEach(log => {
                const li = document.createElement('li');
                li.className = 'list-item comm-log-item';
                const date = new Date(log.timestamp).toLocaleString();
                li.innerHTML = `
                    <span>${log.message}</span>
                    <small>${date}</small>
                `;
                commListEl.appendChild(li);
            });
        }

        function renderTasks(projectId) {
            document.querySelectorAll('.kanban-tasks').forEach(col => col.innerHTML = '');
            const project = allProjects.find(p => p.id === projectId);
            if (!project || !project.tasks) return;

            project.tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                taskCard.classList.add(`priority-${task.priority || 'low'}`);
                taskCard.draggable = true;
                taskCard.dataset.taskId = task.id;
                taskCard.innerHTML = `
                    <div class="task-name">${task.name}</div>
                    <div class="task-details">
                        <div>üë§ ${task.assignee}</div>
                        <div>üóìÔ∏è ${formatDateGerman(task.startDate)} ‚Üí ${formatDateGerman(task.endDate)}</div>
                    </div>
                `;
                
                const column = document.querySelector(`.kanban-column[data-status="${task.status}"] .kanban-tasks`);
                if (column) {
                    column.appendChild(taskCard);
                }
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const display = document.getElementById('month-year-display');
            grid.innerHTML = '';

            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();

            display.textContent = new Date(year, month).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'].forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            for (let i = 0; i < (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1); i++) {
                grid.appendChild(document.createElement('div'));
            }

            const allTasks = allProjects.flatMap(p => p.tasks.map(t => ({...t, projectName: p.name})));

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                
                const currentDate = new Date(year, month, day);
                allTasks.forEach(task => {
                    const startDate = new Date(task.startDate);
                    const endDate = new Date(task.endDate);
                    if (currentDate >= startDate && currentDate <= endDate) {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'calendar-task';
                        taskEl.textContent = `${task.projectName}: ${task.name}`;
                        dayCell.appendChild(taskEl);
                    }
                });
                grid.appendChild(dayCell);
            }
        }
        
        async function renderContacts() {
            allContacts = await contactService.getAll();
            const contactListEl = document.getElementById('contact-list');
            contactListEl.innerHTML = '';
            if (allContacts.length === 0) {
                contactListEl.innerHTML = '<li class="list-item">No contacts yet.</li>';
                return;
            }
            allContacts.forEach(contact => {
                const li = document.createElement('li');
                li.className = 'contact-item';
                li.dataset.contactId = contact.id;
                li.innerHTML = `
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-company">${contact.company}</div>
                        <div>üìß ${contact.email || 'N/A'}</div>
                        <div>üìû ${contact.phone || 'N/A'}</div>
                        <div class="contact-channels">
                            ${contact.whatsapp ? '<span>üü¢ WhatsApp</span>' : ''}
                            ${contact.wechat ? '<span>üí¨ WeChat</span>' : ''}
                            ${contact.signal ? '<span>üîí Signal</span>' : ''}
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="project-action-btn" data-action="edit-contact">‚úèÔ∏è</button>
                        <button class="project-action-btn" data-action="delete-contact">üóëÔ∏è</button>
                    </div>
                `;
                contactListEl.appendChild(li);
            });
        }

        // --- EVENT LISTENERS ---
        document.getElementById('sidebar').addEventListener('click', (e) => {
            const newProjectBtn = e.target.closest('#new-project-btn');
            const actionTarget = e.target.closest('[data-action]');
            
            if (newProjectBtn) {
                showModal({
                    title: 'Create New Project',
                    inputs: [{ label: 'Project Name' }],
                    confirmText: 'Create'
                }).then(async ({ confirmed, inputs }) => {
                    if (confirmed && inputs[0]) {
                        const newProject = await projectService.add({ name: inputs[0], parentId: currentProjectId || null });
                        allProjects.push(newProject);
                        if (currentProjectId) expandedProjects.add(currentProjectId);
                        addProjectNodeToDOM(newProject);
                        selectProject(newProject.id);
                    }
                });
                return;
            }

            if (actionTarget) {
                const action = actionTarget.dataset.action;
                const projectItem = actionTarget.closest('.project-item');
                const projectId = projectItem.parentElement.dataset.id;
                const project = allProjects.find(p => p.id === projectId);

                switch (action) {
                    case 'select':
                        selectProject(projectId);
                        const sublist = projectItem.parentElement.querySelector('ul');
                        if (sublist) {
                            const isHidden = sublist.style.display === 'none';
                            sublist.style.display = isHidden ? 'block' : 'none';
                            projectItem.querySelector('.toggle').textContent = isHidden ? '‚ñº' : '‚ñ∂';
                            if (isHidden) expandedProjects.add(projectId);
                            else expandedProjects.delete(projectId);
                        }
                        break;
                    
                    case 'rename':
                        showModal({
                            title: `Rename "${project.name}"`,
                            inputs: [{ label: 'New Project Name', value: project.name }],
                            confirmText: 'Rename'
                        }).then(async ({ confirmed, inputs }) => {
                            if (confirmed && inputs[0]) {
                                await projectService.renameProject(projectId, inputs[0]);
                                initializeApp();
                            }
                        });
                        break;

                    case 'delete':
                        showModal({
                            title: 'Delete Project',
                            message: `Are you sure you want to delete "${project.name}" and all its sub-projects? This action cannot be undone.`,
                            confirmText: 'Delete',
                            danger: true
                        }).then(async ({ confirmed }) => {
                            if (confirmed) {
                                await projectService.deleteProject(projectId);
                                if (currentProjectId === projectId) currentProjectId = null;
                                initializeApp();
                            }
                        });
                        break;
                }
            }
        });
        
        document.getElementById('main-nav').addEventListener('click', (e) => {
            const clickedNavItem = e.target.closest('.main-nav-item');
            if (!clickedNavItem) return;

            document.querySelectorAll('.main-nav-item').forEach(item => item.classList.remove('active'));
            clickedNavItem.classList.add('active');

            document.querySelectorAll('.main-panel').forEach(panel => panel.classList.remove('active'));
            const panelId = clickedNavItem.dataset.panel;
            document.getElementById(panelId).classList.add('active');

            if (panelId === 'calendar-panel') renderCalendar();
            if (panelId === 'contacts-panel') renderContacts();
        });

        document.getElementById('project-tabs').addEventListener('click', (e) => {
            const clickedTab = e.target.closest('.tab-button');
            if (!clickedTab) return;

            document.querySelectorAll('#project-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            clickedTab.classList.add('active');

            document.querySelectorAll('.tab-content-container .tab-panel').forEach(panel => panel.classList.remove('active'));
            const tabId = clickedTab.dataset.tab;
            document.getElementById(tabId).classList.add('active');
        });

        document.getElementById('add-document-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            showModal({
                title: 'Add New Document',
                inputs: [ { label: 'Document Name' }, { label: 'Document URL' } ],
                confirmText: 'Add'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0] && inputs[1]) {
                    await projectService.addDocument(currentProjectId, { name: inputs[0], url: inputs[1] });
                    allProjects = await projectService.getAll();
                    renderDocuments(currentProjectId);
                }
            });
        });

        document.getElementById('add-member-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            const project = allProjects.find(p => p.id === currentProjectId);
            const memberOptions = allContacts
                .filter(c => !project.team.includes(c.id)) // Filter out existing members
                .map(c => ({ value: c.id, text: c.name }));

            if (memberOptions.length === 0) {
                return alert("All available contacts are already on this team.");
            }

            showModal({
                title: 'Add Team Member',
                inputs: [{ label: 'Select Contact', type: 'select', options: memberOptions }],
                confirmText: 'Add'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    await projectService.addTeamMember(currentProjectId, inputs[0]);
                    allProjects = await projectService.getAll();
                    renderTeam(currentProjectId);
                }
            });
        });

        teamListEl.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-btn');
            if (removeBtn) {
                const contactId = removeBtn.dataset.contactId;
                showModal({
                    title: 'Remove Team Member',
                    message: 'Are you sure you want to remove this member from the project?',
                    confirmText: 'Remove',
                    danger: true
                }).then(async ({ confirmed }) => {
                    if (confirmed) {
                        await projectService.removeTeamMember(currentProjectId, contactId);
                        allProjects = await projectService.getAll();
                        renderTeam(currentProjectId);
                    }
                });
            }
        });
        
        document.getElementById('add-comm-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            showModal({
                title: 'Add Communication Log',
                inputs: [{ label: 'Log Message' }],
                confirmText: 'Add Log'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    await projectService.addCommLog(currentProjectId, inputs[0]);
                    allProjects = await projectService.getAll();
                    renderComms(currentProjectId);
                }
            });
        });

        document.getElementById('add-task-btn').addEventListener('click', () => {
            if (!currentProjectId) return alert("Please select a project first.");
            const project = allProjects.find(p => p.id === currentProjectId);
            const teamContacts = allContacts.filter(c => project.team.includes(c.id));
            
            const assigneeOptions = [{ value: 'Me (Email)', text: 'Me (Email)' }];
            teamContacts.forEach(contact => {
                if(contact.whatsapp) assigneeOptions.push({ value: `${contact.name} (WhatsApp)`, text: `${contact.name} (WhatsApp)` });
                if(contact.wechat) assigneeOptions.push({ value: `${contact.name} (WeChat)`, text: `${contact.name} (WeChat)` });
                if(contact.signal) assigneeOptions.push({ value: `${contact.name} (Signal)`, text: `${contact.name} (Signal)` });
                if(contact.email) assigneeOptions.push({ value: `${contact.name} (Email)`, text: `${contact.name} (Email)` });
            });

            const priorityOptions = [
                { value: 'low', text: 'Low' }, { value: 'medium', text: 'Medium' }, { value: 'high', text: 'High' }
            ];

            showModal({
                title: 'Add New Task',
                inputs: [
                    { label: 'Task Name' },
                    { label: 'Assign To', type: 'select', options: assigneeOptions },
                    { label: 'Priority', type: 'select', options: priorityOptions },
                    { label: 'Start Date', type: 'date' },
                    { label: 'End Date', type: 'date' }
                ],
                confirmText: 'Add Task'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    const [name, assignee, priority, startDate, endDate] = inputs;
                    await projectService.addTask(currentProjectId, { name, assignee, priority, startDate, endDate, description: '' });
                    allProjects = await projectService.getAll();
                    renderTasks(currentProjectId);
                }
            });
        });

        const kanbanBoard = document.querySelector('.kanban-board');
        let draggedTask = null;

        kanbanBoard.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('task-card')) {
                draggedTask = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }
        });

        kanbanBoard.addEventListener('dragend', (e) => {
            if (draggedTask) {
                draggedTask.classList.remove('dragging');
                draggedTask = null;
            }
        });
        
        kanbanBoard.addEventListener('dragover', (e) => {
            e.preventDefault();
            const dropZone = e.target.closest('.kanban-tasks');
            if (dropZone) dropZone.classList.add('drag-over');
        });

        kanbanBoard.addEventListener('dragleave', (e) => {
            const dropZone = e.target.closest('.kanban-tasks');
            if (dropZone) dropZone.classList.remove('drag-over');
        });

        kanbanBoard.addEventListener('drop', async (e) => {
            e.preventDefault();
            const dropZone = e.target.closest('.kanban-tasks');
            if (dropZone) {
                dropZone.classList.remove('drag-over');
                const column = dropZone.closest('.kanban-column');
                if (column && draggedTask) {
                    const newStatus = column.dataset.status;
                    const taskId = draggedTask.dataset.taskId;
                    
                    await projectService.updateTaskStatus(currentProjectId, taskId, newStatus);
                    allProjects = await projectService.getAll();
                    renderTasks(currentProjectId);
                }
            }
        });

        kanbanBoard.addEventListener('click', (e) => {
            const taskCard = e.target.closest('.task-card');
            if (!taskCard) return;
            
            const taskId = taskCard.dataset.taskId;
            const project = allProjects.find(p => p.id === currentProjectId);
            const task = project.tasks.find(t => t.id === taskId);
            
             const teamContacts = allContacts.filter(c => project.team.includes(c.id));
            const assigneeOptions = [{ value: 'Me (Email)', text: 'Me (Email)' }];
            teamContacts.forEach(contact => {
                if(contact.whatsapp) assigneeOptions.push({ value: `${contact.name} (WhatsApp)`, text: `${contact.name} (WhatsApp)` });
                if(contact.wechat) assigneeOptions.push({ value: `${contact.name} (WeChat)`, text: `${contact.name} (WeChat)` });
                if(contact.signal) assigneeOptions.push({ value: `${contact.name} (Signal)`, text: `${contact.name} (Signal)` });
                if(contact.email) assigneeOptions.push({ value: `${contact.name} (Email)`, text: `${contact.name} (Email)` });
            });

            const priorityOptions = [
                { value: 'low', text: 'Low' }, { value: 'medium', text: 'Medium' }, { value: 'high', text: 'High' }
            ];

             showModal({
                title: 'Edit Task',
                inputs: [
                    { label: 'Task Name', value: task.name },
                    { label: 'Assign To', type: 'select', options: assigneeOptions, value: task.assignee },
                    { label: 'Priority', type: 'select', options: priorityOptions, value: task.priority },
                    { label: 'Start Date', type: 'date', value: task.startDate },
                    { label: 'End Date', type: 'date', value: task.endDate },
                    { label: 'Description', type: 'textarea', value: task.description }
                ],
                confirmText: 'Save Changes'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed) {
                    const [name, assignee, priority, startDate, endDate, description] = inputs;
                    await projectService.updateTask(currentProjectId, taskId, { name, assignee, priority, startDate, endDate, description });
                    allProjects = await projectService.getAll();
                    renderTasks(currentProjectId);
                }
            });
        });

        document.getElementById('add-contact-btn').addEventListener('click', () => {
            showModal({
                title: 'Add New Contact',
                inputs: [
                    { label: 'Name' }, { label: 'Email' }, { label: 'Phone' }, { label: 'Company' },
                    { label: 'WhatsApp' }, { label: 'WeChat' }, { label: 'Signal' }
                ],
                confirmText: 'Save Contact'
            }).then(async ({ confirmed, inputs }) => {
                if (confirmed && inputs[0]) {
                    const [name, email, phone, company, whatsapp, wechat, signal] = inputs;
                    await contactService.add({ name, email, phone, company, whatsapp, wechat, signal });
                    renderContacts();
                }
            });
        });

        document.getElementById('contact-list').addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;

            const action = actionTarget.dataset.action;
            const contactItem = actionTarget.closest('.contact-item');
            const contactId = contactItem.dataset.contactId;
            const contact = allContacts.find(c => c.id === contactId);

            if (action === 'edit-contact') {
                showModal({
                    title: 'Edit Contact',
                    inputs: [
                        { label: 'Name', value: contact.name },
                        { label: 'Email', value: contact.email },
                        { label: 'Phone', value: contact.phone },
                        { label: 'Company', value: contact.company },
                        { label: 'WhatsApp', value: contact.whatsapp },
                        { label: 'WeChat', value: contact.wechat },
                        { label: 'Signal', value: contact.signal }
                    ],
                    confirmText: 'Save Changes'
                }).then(async ({ confirmed, inputs }) => {
                    if (confirmed) {
                        const [name, email, phone, company, whatsapp, wechat, signal] = inputs;
                        await contactService.update(contactId, { name, email, phone, company, whatsapp, wechat, signal });
                        renderContacts();
                    }
                });
            } else if (action === 'delete-contact') {
                showModal({
                    title: 'Delete Contact',
                    message: `Are you sure you want to delete ${contact.name}?`,
                    confirmText: 'Delete',
                    danger: true
                }).then(async ({ confirmed }) => {
                    if (confirmed) {
                        await contactService.delete(contactId);
                        renderContacts();
                    }
                });
            }
        });

        // Calendar Navigation
        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });

        // --- INITIALIZATION ---
        async function initializeApp() {
            let existingProjects = await projectService.getAll();
            let needsSave = false;
            existingProjects.forEach(p => {
                if (!p.icon) {
                    p.icon = getIconForProjectName(p.name);
                    needsSave = true;
                }
            });
            if (needsSave) {
                await projectService.saveAll(existingProjects);
            }

            if (existingProjects.length === 0) {
                 await projectService.add({ name: 'Main Project Alpha' });
                 existingProjects = await projectService.getAll();
            }

            allProjects = existingProjects;
            await renderProjectTree();
            
            if (!currentProjectId && allProjects.length > 0) {
                 const firstProjectId = allProjects.find(p => !p.parentId)?.id || allProjects[0].id;
                 selectProject(firstProjectId);
            } else if (allProjects.length === 0) {
                selectProject(null);
            } else {
                selectProject(currentProjectId);
            }
            renderCalendar();
            renderContacts();
        }

        initializeApp();
    </script>
</body>
</html>
